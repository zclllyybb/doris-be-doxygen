\hypertarget{file__helper_8h_source}{}\doxysection{file\+\_\+helper.\+h}
\label{file__helper_8h_source}\index{/Users/dabowang/be\_all/olap/file\_helper.h@{/Users/dabowang/be\_all/olap/file\_helper.h}}
\mbox{\hyperlink{file__helper_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <sys/stat.h>}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lru__cache_8h}{olap/lru\_cache.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{olap_2olap__common_8h}{olap/olap\_common.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{olap__define_8h}{olap/olap\_define.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{olap_2utils_8h}{olap/utils.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{debug__util_8h}{util/debug\_util.h}}"{}}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_file_descriptor}{FileDescriptor}}\ \{}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{struct_file_descriptor_a6f8059414f0228f0256115e024eeed4b}{fd}};}
\DoxyCodeLine{00037\ \ \ \ \ \mbox{\hyperlink{struct_file_descriptor_a291e09c41f5031ca366f07fa6ac6f705}{FileDescriptor}}(\textcolor{keywordtype}{int}\ fd)\ :\ fd(fd)\ \{\}}
\DoxyCodeLine{00038\ \ \ \ \ \mbox{\hyperlink{struct_file_descriptor_ac1b64e686b4855a97eb1835f49610789}{\string~FileDescriptor}}()\ \{\ ::close(fd);\ \}}
\DoxyCodeLine{00039\ \}\ \mbox{\hyperlink{struct_file_descriptor}{FileDescriptor}};}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_file_handler}{FileHandler}}\ \{}
\DoxyCodeLine{00042\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00043\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_handler_a7a105e8757c6bbbe0e6be820ce84f1ed}{FileHandler}}();}
\DoxyCodeLine{00044\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_handler_af21f1ebc53f4b79a0cda634bef0a6137}{\string~FileHandler}}();}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a366e3a81a2f35feafe297cc2a3a1d42a}{open}}(\textcolor{keyword}{const}\ std::string\&\ \mbox{\hyperlink{classdoris_1_1_file_handler_aad46c37f7ffabb7a5ac6d914b28bebdc}{file\_name}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacedoris_aa22c8aa4a1f9eb102cc140540239702e}{flag}});}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{comment}{//\ The\ argument\ mode\ specifies\ the\ permissions\ to\ use\ in\ case\ a\ new\ file\ is\ created.}}
\DoxyCodeLine{00048\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a7dddc1afbbc3b2c2979b1895caad7113}{open\_with\_mode}}(\textcolor{keyword}{const}\ std::string\&\ \mbox{\hyperlink{classdoris_1_1_file_handler_aad46c37f7ffabb7a5ac6d914b28bebdc}{file\_name}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacedoris_aa22c8aa4a1f9eb102cc140540239702e}{flag}},\ \textcolor{keywordtype}{int}\ mode);}
\DoxyCodeLine{00049\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_aee1c6f7d85af14d039dec07dc31ae862}{close}}();}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a4ff8f393d11495cd61e5e59ad2b3afba}{pread}}(\textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ size,\ \textcolor{keywordtype}{size\_t}\ offset);}
\DoxyCodeLine{00052\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a428f69caf2ebbdb9e44a3aab4b737564}{write}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ buf\_size);}
\DoxyCodeLine{00053\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_aa54665259fbf06d7ddcf9ee0ab3a59c3}{pwrite}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ buf\_size,\ \textcolor{keywordtype}{size\_t}\ offset);}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_a5dcfc787ad2ea84354d1846b6fc6585a}{sync}}()\ \{\ \textcolor{keywordflow}{return}\ 0;\ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_a6e8ce06f95605b89cfcee42fc3e5162c}{tell}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ off\_t\ res\ =\ -\/1;}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/1\ ==\ (res\ =\ lseek(\mbox{\hyperlink{classdoris_1_1_file_handler_a8a78a7e56615ccca60bdfdfce3251b36}{\_fd}},\ 0,\ SEEK\_CUR)))\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ tell\ file.\ [err="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ file\_name='"{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}}\ <<\ \textcolor{stringliteral}{"{}'\ fd="{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_a8a78a7e56615ccca60bdfdfce3251b36}{\_fd}}\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ res;}
\DoxyCodeLine{00067\ \ \ \ \ \}}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_a171e0085cec3936e33278c203d9cb73d}{length}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_aa41fd7acd6b2feb15e78ce734a95caa3}{seek}}(off\_t\ offset,\ \textcolor{keywordtype}{int}\ whence)\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ off\_t\ res\ =\ -\/1;}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/1\ ==\ (res\ =\ lseek(\mbox{\hyperlink{classdoris_1_1_file_handler_a8a78a7e56615ccca60bdfdfce3251b36}{\_fd}},\ offset,\ whence)))\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ seek\ file.\ [err="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}file\_name='"{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}}\ <<\ \textcolor{stringliteral}{"{}'\ fd="{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_a8a78a7e56615ccca60bdfdfce3251b36}{\_fd}}\ <<\ \textcolor{stringliteral}{"{}\ offset="{}}\ <<\ offset}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ whence="{}}\ <<\ whence\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ res;}
\DoxyCodeLine{00082\ \ \ \ \ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keyword}{const}\ std::string\&\ \mbox{\hyperlink{classdoris_1_1_file_handler_aad46c37f7ffabb7a5ac6d914b28bebdc}{file\_name}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_handler_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}};\ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a29796278ef86a9baab9da2cd2667ee07}{fd}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a8a78a7e56615ccca60bdfdfce3251b36}{\_fd}};\ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a1fa79248fd520af51149afa1b33e754b}{\_delete\_cache\_file\_descriptor}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1_cache_key}{CacheKey}}\&\ key,\ \textcolor{keywordtype}{void}*\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}})\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_file_descriptor}{FileDescriptor}}*\ file\_desc\ =\ \textcolor{keyword}{reinterpret\_cast<}\mbox{\hyperlink{struct_file_descriptor}{FileDescriptor}}*\textcolor{keyword}{>}(\mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}});}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{olap__define_8h_ad45c5447fa213228e8493458c1770e91}{SAFE\_DELETE}}(file\_desc);}
\DoxyCodeLine{00091\ \ \ \ \ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00094\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a46c43965c6273be5e68612a7479dcd1b}{\_release}}();}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_file_handler_a8a78a7e56615ccca60bdfdfce3251b36}{\_fd}};}
\DoxyCodeLine{00097\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_aff6e4b40a72255c2ef7fd454195d53fb}{\_wr\_length}};}
\DoxyCodeLine{00098\ \ \ \ \ std::string\ \mbox{\hyperlink{classdoris_1_1_file_handler_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}};}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \textcolor{preprocessor}{\#ifndef\ \_\_APPLE\_\_}}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keyword}{const}\ int64\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_a50567ca18e3ad36dd5f2a91ac65f0832}{\_cache\_threshold}}\ =\ 1\ <<\ 19;}
\DoxyCodeLine{00102\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00103\ \};}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_file_handler_with_buf}{FileHandlerWithBuf}}\ \{}
\DoxyCodeLine{00106\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00107\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_ad5cd7ea449fb4a5b45b1bae4f4a60a4d}{FileHandlerWithBuf}}();}
\DoxyCodeLine{00108\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_ace69bd86945a6a31efcd0cd6d5a83d3c}{\string~FileHandlerWithBuf}}();}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a795ecb2f19742170f1cef400f7034805}{open}}(\textcolor{keyword}{const}\ std::string\&\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aad46c37f7ffabb7a5ac6d914b28bebdc}{file\_name}},\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ mode);}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{comment}{//\ The\ argument\ mode\ specifies\ the\ permissions\ to\ use\ in\ case\ a\ new\ file\ is\ created.}}
\DoxyCodeLine{00112\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a8392dfbef2b893f9b2116f1958e7b028}{open\_with\_mode}}(\textcolor{keyword}{const}\ std::string\&\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aad46c37f7ffabb7a5ac6d914b28bebdc}{file\_name}},\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ mode);}
\DoxyCodeLine{00113\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aee1c6f7d85af14d039dec07dc31ae862}{close}}();}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a920faf57bd7157455e476baeb73bd6a3}{read}}(\textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ size);}
\DoxyCodeLine{00116\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a4ff8f393d11495cd61e5e59ad2b3afba}{pread}}(\textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ size,\ \textcolor{keywordtype}{size\_t}\ offset);}
\DoxyCodeLine{00117\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a428f69caf2ebbdb9e44a3aab4b737564}{write}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ buf\_size);}
\DoxyCodeLine{00118\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa54665259fbf06d7ddcf9ee0ab3a59c3}{pwrite}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ buf\_size,\ \textcolor{keywordtype}{size\_t}\ offset);}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a5dcfc787ad2ea84354d1846b6fc6585a}{sync}}()\ \{}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ int32\_t\ res\ =\ -\/1;}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (0\ !=\ (res\ =\ ::fflush(\mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa4258512d38016621f8291636377fb9e}{\_fp}})))\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ fsync\ file.\ [err=\ "{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ file\_name='"{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}}\ <<\ \textcolor{stringliteral}{"{}']"{}};}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ res;}
\DoxyCodeLine{00128\ \ \ \ \ \}}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a6e8ce06f95605b89cfcee42fc3e5162c}{tell}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ off\_t\ res\ =\ -\/1;}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/1\ ==\ (res\ =\ ::ftell(\mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa4258512d38016621f8291636377fb9e}{\_fp}})))\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ tell\ file.\ [err=\ "{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ file\_name='"{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}}\ <<\ \textcolor{stringliteral}{"{}']"{}};}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ res;}
\DoxyCodeLine{00138\ \ \ \ \ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a171e0085cec3936e33278c203d9cb73d}{length}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ off\_t\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa41fd7acd6b2feb15e78ce734a95caa3}{seek}}(off\_t\ offset,\ \textcolor{keywordtype}{int}\ whence)\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ off\_t\ res\ =\ -\/1;}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/1\ ==\ (res\ =\ ::fseek(\mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa4258512d38016621f8291636377fb9e}{\_fp}},\ offset,\ whence)))\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ seek\ file.\ [err="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ file\_name='"{}}\ <<\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}}\ <<\ \textcolor{stringliteral}{"{}'\ offset="{}}\ <<\ offset}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ whence="{}}\ <<\ whence\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ res;}
\DoxyCodeLine{00151\ \ \ \ \ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{keyword}{const}\ std::string\&\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aad46c37f7ffabb7a5ac6d914b28bebdc}{file\_name}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}};\ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_a29796278ef86a9baab9da2cd2667ee07}{fd}}()\ \{\ return\ ::fileno(\mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa4258512d38016621f8291636377fb9e}{\_fp}});\ \}}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00158\ \ \ \ \ FILE*\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aa4258512d38016621f8291636377fb9e}{\_fp}};}
\DoxyCodeLine{00159\ \ \ \ \ std::string\ \mbox{\hyperlink{classdoris_1_1_file_handler_with_buf_aabe9a05e7efc4b887c62ffd6cfd61fa8}{\_file\_name}};}
\DoxyCodeLine{00160\ \};}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1___fixed_file_header}{\_FixedFileHeader}}\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{comment}{//\ the\ length\ of\ the\ entire\ file}}
\DoxyCodeLine{00164\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_a65fe5f9e6b0d2c3c3aa21531d3ceee0d}{file\_length}};}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ Checksum\ of\ the\ file's\ contents\ except\ the\ FileHeader}}
\DoxyCodeLine{00166\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_aa482bc33779a87f57ab8efc2c1680c48}{checksum}};}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ Protobuf\ length\ of\ section}}
\DoxyCodeLine{00168\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_ad4ca563d0f12ecb3a05bb0596ecff32f}{protobuf\_length}};}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{comment}{//\ Checksum\ of\ Protobuf\ part}}
\DoxyCodeLine{00170\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_ac7ff35e56f54a4f9ef82bef879feb5aa}{protobuf\_checksum}};}
\DoxyCodeLine{00171\ \}\ \mbox{\hyperlink{namespacedoris_ac94a4f420e9be2395a84d23a78a82341}{\_\_attribute\_\_}}((packed))\ FixedFileHeader;}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00173\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2}{\_FixedFileHeaderV2}}\ \{}
\DoxyCodeLine{00174\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2_a21f6bef30d570bbf0620bc1e00a254ea}{magic\_number}};}
\DoxyCodeLine{00175\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2_acd99bb05ca015e7d74448acb1deba7ca}{version}};}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{comment}{//\ the\ length\ of\ the\ entire\ file}}
\DoxyCodeLine{00177\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2_acf8ae60975aa59fb0f518b17f3a973d7}{file\_length}};}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{comment}{//\ Checksum\ of\ the\ file's\ contents\ except\ the\ FileHeader}}
\DoxyCodeLine{00179\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2_aa482bc33779a87f57ab8efc2c1680c48}{checksum}};}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{comment}{//\ Protobuf\ length\ of\ section}}
\DoxyCodeLine{00181\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2_a6b99548f617bd3318c1841d003e4c77e}{protobuf\_length}};}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{comment}{//\ Checksum\ of\ Protobuf\ part}}
\DoxyCodeLine{00183\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{structdoris_1_1___fixed_file_header_v2_ac7ff35e56f54a4f9ef82bef879feb5aa}{protobuf\_checksum}};}
\DoxyCodeLine{00184\ \}\ \mbox{\hyperlink{namespacedoris_ac94a4f420e9be2395a84d23a78a82341}{\_\_attribute\_\_}}((packed))\ FixedFileHeaderV2;}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ MessageType,\ \textcolor{keyword}{typename}\ ExtraType\ =\ uint32\_t,}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ FileHandlerType\ =\ \mbox{\hyperlink{classdoris_1_1_file_handler}{FileHandler}}>}
\DoxyCodeLine{00188\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_file_header}{FileHeader}}\ \{}
\DoxyCodeLine{00189\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00190\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_header_aa32dc1910cde925eea60821d1dffd400}{FileHeader}}()\ \{}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ memset(\&\mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}},\ 0,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}}));}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ memset(\&\mbox{\hyperlink{classdoris_1_1_file_header_acfcd5c473ece293ce19ec3421c7184ad}{\_extra\_fixed\_header}},\ 0,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classdoris_1_1_file_header_acfcd5c473ece293ce19ec3421c7184ad}{\_extra\_fixed\_header}}));}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_header_ae05fb0fa7b91ee7f36c295387ba68a79}{\_fixed\_file\_header\_size}}\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}});}
\DoxyCodeLine{00194\ \ \ \ \ \}}
\DoxyCodeLine{00195\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_header_ac389ef7303cad555c54ceb759e2d3681}{\string~FileHeader}}()\ \{\}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{comment}{//\ To\ calculate\ the\ length\ of\ the\ proto\ part,\ it\ needs\ to\ be\ called\ after\ the\ proto\ is\ operated,\ and\ prepare\ must\ be\ called\ before\ calling\ serialize}}
\DoxyCodeLine{00198\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_ad5883f278da56277680c0da0433fb412}{prepare}}(FileHandlerType*\ file\_handler);}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{comment}{//\ call\ prepare()\ first,\ serialize()\ will\ write\ fixed\ header\ and\ protobuffer.}}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{comment}{//\ Write\ the\ header\ to\ the\ starting\ position\ of\ the\ incoming\ file\ handle}}
\DoxyCodeLine{00202\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_ac0f27fbce770e1040fde70b36e25ddca}{serialize}}(FileHandlerType*\ file\_handler);}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{comment}{//\ read\ from\ file,\ validate\ file\ length,\ signature\ and\ alder32\ of\ protobuffer.}}
\DoxyCodeLine{00205\ \ \ \ \ \textcolor{comment}{//\ Read\ the\ header\ from\ the\ beginning\ of\ the\ incoming\ file\ handle}}
\DoxyCodeLine{00206\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_a96dd41bcb5538d60a4b4126566403a48}{unserialize}}(FileHandlerType*\ file\_handler);}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{comment}{//\ Check\ the\ validity\ of\ Header}}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{comment}{//\ it\ is\ actually\ call\ unserialize().}}
\DoxyCodeLine{00210\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_a28c7532496270a7d14a5037b8abe81f6}{validate}}(\textcolor{keyword}{const}\ std::string\&\ filename);}
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{classdoris_1_1_file_header_a853f3973d6a697b64aeafc4851e392e0}{file\_length}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}}.file\_length;\ \}}
\DoxyCodeLine{00213\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{classdoris_1_1_file_header_ae1c6bbe940b09dac105c57bd8895ad59}{checksum}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}}.checksum;\ \}}
\DoxyCodeLine{00214\ \ \ \ \ \textcolor{keyword}{const}\ ExtraType\&\ \mbox{\hyperlink{classdoris_1_1_file_header_ac45203fa89ecc4075b16f4835e2fc8d6}{extra}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_header_acfcd5c473ece293ce19ec3421c7184ad}{\_extra\_fixed\_header}};\ \}}
\DoxyCodeLine{00215\ \ \ \ \ ExtraType*\ \mbox{\hyperlink{classdoris_1_1_file_header_a19023d841876433c048818dbb1b59cf9}{mutable\_extra}}()\ \{\ \textcolor{keywordflow}{return}\ \&\mbox{\hyperlink{classdoris_1_1_file_header_acfcd5c473ece293ce19ec3421c7184ad}{\_extra\_fixed\_header}};\ \}}
\DoxyCodeLine{00216\ \ \ \ \ \textcolor{keyword}{const}\ MessageType\&\ \mbox{\hyperlink{classdoris_1_1_file_header_adb554b440d116b9c701526a511d602ee}{message}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_header_aa3953a3ee6c7f402635ccd8f223ad4d7}{\_proto}};\ \}}
\DoxyCodeLine{00217\ \ \ \ \ MessageType*\ \mbox{\hyperlink{classdoris_1_1_file_header_a6ef2c9747d8502c3d2cc4d78247c0eed}{mutable\_message}}()\ \{\ \textcolor{keywordflow}{return}\ \&\mbox{\hyperlink{classdoris_1_1_file_header_aa3953a3ee6c7f402635ccd8f223ad4d7}{\_proto}};\ \}}
\DoxyCodeLine{00218\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{classdoris_1_1_file_header_a762969d9fb827c7c4e4df778152838fe}{size}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_file_header_ae05fb0fa7b91ee7f36c295387ba68a79}{\_fixed\_file\_header\_size}}\ +\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classdoris_1_1_file_header_acfcd5c473ece293ce19ec3421c7184ad}{\_extra\_fixed\_header}})\ +}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}}.protobuf\_length;}
\DoxyCodeLine{00221\ \ \ \ \ \}}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_file_header_a6f79f66027a27583c725ed3763fc5870}{set\_file\_length}}(uint64\_t\ \mbox{\hyperlink{classdoris_1_1_file_header_a853f3973d6a697b64aeafc4851e392e0}{file\_length}})\ \{\ \mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}}.file\_length\ =\ \mbox{\hyperlink{classdoris_1_1_file_header_a853f3973d6a697b64aeafc4851e392e0}{file\_length}};\ \}}
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_file_header_a251dbe0b6faf88f24eba705df41fa385}{set\_checksum}}(uint32\_t\ \mbox{\hyperlink{classdoris_1_1_file_header_ae1c6bbe940b09dac105c57bd8895ad59}{checksum}})\ \{\ \mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}}.checksum\ =\ \mbox{\hyperlink{classdoris_1_1_file_header_ae1c6bbe940b09dac105c57bd8895ad59}{checksum}};\ \}}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00227\ \ \ \ \ FixedFileHeaderV2\ \mbox{\hyperlink{classdoris_1_1_file_header_a62e1d36f8875a32809c7e4b8f3463bea}{\_fixed\_file\_header}};}
\DoxyCodeLine{00228\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{classdoris_1_1_file_header_ae05fb0fa7b91ee7f36c295387ba68a79}{\_fixed\_file\_header\_size}};}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \ \ std::string\ \mbox{\hyperlink{classdoris_1_1_file_header_aa7cfbd2b475f10c80a3bba619b2d1cb9}{\_proto\_string}};}
\DoxyCodeLine{00231\ \ \ \ \ ExtraType\ \mbox{\hyperlink{classdoris_1_1_file_header_acfcd5c473ece293ce19ec3421c7184ad}{\_extra\_fixed\_header}};}
\DoxyCodeLine{00232\ \ \ \ \ MessageType\ \mbox{\hyperlink{classdoris_1_1_file_header_aa3953a3ee6c7f402635ccd8f223ad4d7}{\_proto}};}
\DoxyCodeLine{00233\ \};}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \textcolor{comment}{//\ FileHandler\ implementation}}
\DoxyCodeLine{00236\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ MessageType,\ \textcolor{keyword}{typename}\ ExtraType,\ \textcolor{keyword}{typename}\ FileHandlerType>}
\DoxyCodeLine{00237\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_ad5883f278da56277680c0da0433fb412}{FileHeader<MessageType,\ ExtraType,\ FileHandlerType>::prepare}}(FileHandlerType*\ file\_handler)\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{nullptr}\ ==\ file\_handler)\ \{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::INVALID\_ARGUMENT>();}
\DoxyCodeLine{00240\ \ \ \ \ \}}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{comment}{//\ Use\ the\ file\ name\ as\ Signature\ to\ prevent\ problems\ caused\ by\ some\ misoperations}}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{comment}{//\ \_proto.set\_signature(basename(file\_handler-\/>file\_name().c\_str()));}}
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00245\ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_proto.SerializeToString(\&\_proto\_string))\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}serialize\ file\ header\ to\ string\ error.\ [path='"{}}}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name()\ <<\ \textcolor{stringliteral}{"{}']"{}};}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::SERIALIZE\_PROTOBUF\_ERROR>();}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00251\ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}serialize\ file\ header\ to\ string\ error.\ [path='"{}}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name()\ <<\ \textcolor{stringliteral}{"{}']"{}};}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::SERIALIZE\_PROTOBUF\_ERROR>();}
\DoxyCodeLine{00255\ \ \ \ \ \}}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \ \ \ \ \_fixed\_file\_header.protobuf\_checksum\ =}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacedoris_a77f99f60d5ebd163d89a71f4835d1cea}{olap\_adler32}}(\mbox{\hyperlink{olap_2utils_8h_a8b499a250e64eddf50a865b4c41fc21a}{ADLER32\_INIT}},\ \_proto\_string.c\_str(),\ \_proto\_string.size());}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ \ \ \_fixed\_file\_header.checksum\ =\ 0;}
\DoxyCodeLine{00261\ \ \ \ \ \_fixed\_file\_header.protobuf\_length\ =\ \_proto\_string.size();}
\DoxyCodeLine{00262\ \ \ \ \ \_fixed\_file\_header.file\_length\ =\ size();}
\DoxyCodeLine{00263\ \ \ \ \ \_fixed\_file\_header.version\ =\ \mbox{\hyperlink{namespacedoris_a0a97547c5042d9dccde8c96c8f44a343}{OLAP\_DATA\_VERSION\_APPLIED}};}
\DoxyCodeLine{00264\ \ \ \ \ \_fixed\_file\_header.magic\_number\ =\ \mbox{\hyperlink{namespacedoris_a52d556626fb3747fc3c702c229351487}{OLAP\_FIX\_HEADER\_MAGIC\_NUMBER}};}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00267\ \}}
\DoxyCodeLine{00268\ }
\DoxyCodeLine{00269\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ MessageType,\ \textcolor{keyword}{typename}\ ExtraType,\ \textcolor{keyword}{typename}\ FileHandlerType>}
\DoxyCodeLine{00270\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_ac0f27fbce770e1040fde70b36e25ddca}{FileHeader<MessageType,\ ExtraType,\ FileHandlerType>::serialize}}(}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \ \ FileHandlerType*\ file\_handler)\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{nullptr}\ ==\ file\_handler)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::INVALID\_ARGUMENT>();}
\DoxyCodeLine{00274\ \ \ \ \ \}}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{comment}{//\ write\ to\ file}}
\DoxyCodeLine{00277\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pwrite(\&\_fixed\_file\_header,\ \_fixed\_file\_header\_size,\ 0))\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ write\ fixed\ header\ to\ file.\ [file='"{}}\ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}'\ err="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00282\ \ \ \ \ \}}
\DoxyCodeLine{00283\ }
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pwrite(\&\_extra\_fixed\_header,\ \textcolor{keyword}{sizeof}(\_extra\_fixed\_header),}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_fixed\_file\_header\_size))\ \{}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ write\ extra\ fixed\ header\ to\ file.\ [file='"{}}}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name()\ <<\ \textcolor{stringliteral}{"{}'\ err="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00291\ \ \ \ \ \}}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00293\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pwrite(\_proto\_string.c\_str(),\ \_proto\_string.size(),}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_fixed\_file\_header\_size\ +\ \textcolor{keyword}{sizeof}(\_extra\_fixed\_header)))\ \{}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ write\ proto\ header\ to\ file.\ [file='"{}}\ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}'\ err='"{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)\ <<\ \textcolor{stringliteral}{"{}']"{}};}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00299\ \ \ \ \ \}}
\DoxyCodeLine{00300\ }
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00302\ \}}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00304\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ MessageType,\ \textcolor{keyword}{typename}\ ExtraType,\ \textcolor{keyword}{typename}\ FileHandlerType>}
\DoxyCodeLine{00305\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_a96dd41bcb5538d60a4b4126566403a48}{FileHeader<MessageType,\ ExtraType,\ FileHandlerType>::unserialize}}(}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ FileHandlerType*\ file\_handler)\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{nullptr}\ ==\ file\_handler)\ \{}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::INVALID\_ARGUMENT>();}
\DoxyCodeLine{00309\ \ \ \ \ \}}
\DoxyCodeLine{00310\ }
\DoxyCodeLine{00311\ \ \ \ \ off\_t\ real\_file\_length\ =\ 0;}
\DoxyCodeLine{00312\ \ \ \ \ uint32\_t\ real\_protobuf\_checksum\ =\ 0;}
\DoxyCodeLine{00313\ }
\DoxyCodeLine{00314\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pread(\&\_fixed\_file\_header,\ \_fixed\_file\_header\_size,\ 0))\ \{}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ load\ header\ structure\ from\ file.\ file="{}}}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name()\ <<\ \textcolor{stringliteral}{"{},\ error="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64);}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00319\ \ \ \ \ \}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_fixed\_file\_header.magic\_number\ !=\ \mbox{\hyperlink{namespacedoris_a52d556626fb3747fc3c702c229351487}{OLAP\_FIX\_HEADER\_MAGIC\_NUMBER}})\ \{}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logging_8h_ace9b2c38f8012a52a2199f1137e45d9e}{VLOG\_TRACE}}\ <<\ \textcolor{stringliteral}{"{}old\ fix\ header\ found,\ magic\ num="{}}\ <<\ \_fixed\_file\_header.magic\_number;}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ FixedFileHeader\ tmp\_header;}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pread(\&tmp\_header,\ \textcolor{keyword}{sizeof}(tmp\_header),\ 0))\ \{}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ load\ header\ structure\ from\ file.\ file="{}}}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ error="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64);}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \_fixed\_file\_header.file\_length\ =\ tmp\_header.file\_length;}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \_fixed\_file\_header.checksum\ =\ tmp\_header.checksum;}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \_fixed\_file\_header.protobuf\_length\ =\ tmp\_header.protobuf\_length;}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \_fixed\_file\_header.protobuf\_checksum\ =\ tmp\_header.protobuf\_checksum;}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \_fixed\_file\_header.magic\_number\ =\ \mbox{\hyperlink{namespacedoris_a52d556626fb3747fc3c702c229351487}{OLAP\_FIX\_HEADER\_MAGIC\_NUMBER}};}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \_fixed\_file\_header.version\ =\ \mbox{\hyperlink{namespacedoris_a0a97547c5042d9dccde8c96c8f44a343}{OLAP\_DATA\_VERSION\_APPLIED}};}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \_fixed\_file\_header\_size\ =\ \textcolor{keyword}{sizeof}(tmp\_header);}
\DoxyCodeLine{00341\ \ \ \ \ \}}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \ \ \mbox{\hyperlink{logging_8h_a18eaecaf99d52cb40ba1da6343fa8449}{VLOG\_NOTICE}}\ <<\ \textcolor{stringliteral}{"{}fix\ head\ loaded.\ file\_length="{}}\ <<\ \_fixed\_file\_header.file\_length}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ checksum="{}}\ <<\ \_fixed\_file\_header.checksum}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ protobuf\_length="{}}\ <<\ \_fixed\_file\_header.protobuf\_length}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ magic\_number="{}}\ <<\ \_fixed\_file\_header.magic\_number}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ version="{}}\ <<\ \_fixed\_file\_header.version;}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pread(\&\_extra\_fixed\_header,\ \textcolor{keyword}{sizeof}(\_extra\_fixed\_header),}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_fixed\_file\_header\_size))\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ load\ extra\ fixed\ header\ from\ file.\ file="{}}}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name()\ <<\ \textcolor{stringliteral}{"{},\ error="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64);}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00355\ \ \ \ \ \}}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ \ \ \ \ std::unique\_ptr<char[]>\ buf(\textcolor{keyword}{new}\ (std::nothrow)\ \textcolor{keywordtype}{char}[\_fixed\_file\_header.protobuf\_length]);}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{nullptr}\ ==\ buf.get())\ \{}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}malloc\ protobuf\ buf\ error.\ file="{}}\ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ error="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64);}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::MEM\_ALLOC\_FAILED>();}
\DoxyCodeLine{00364\ \ \ \ \ \}}
\DoxyCodeLine{00365\ }
\DoxyCodeLine{00366\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler-\/>pread(buf.get(),\ \_fixed\_file\_header.protobuf\_length,}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_fixed\_file\_header\_size\ +\ \textcolor{keyword}{sizeof}(\_extra\_fixed\_header)))\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ load\ protobuf\ from\ file.\ file="{}}\ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ error="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64);}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00372\ \ \ \ \ \}}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00374\ \ \ \ \ real\_file\_length\ =\ file\_handler-\/>length();}
\DoxyCodeLine{00375\ }
\DoxyCodeLine{00376\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{file__helper_8h_acf8ae60975aa59fb0f518b17f3a973d7}{file\_length}}()\ !=\ \textcolor{keyword}{static\_cast<}uint64\_t\textcolor{keyword}{>}(real\_file\_length))\ \{}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}file\ length\ is\ not\ match.\ file="{}}\ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ file\_length="{}}\ <<\ \mbox{\hyperlink{file__helper_8h_acf8ae60975aa59fb0f518b17f3a973d7}{file\_length}}()}
\DoxyCodeLine{00379\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ real\_file\_length="{}}\ <<\ real\_file\_length;}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::FILE\_DATA\_ERROR>();}
\DoxyCodeLine{00381\ \ \ \ \ \}}
\DoxyCodeLine{00382\ }
\DoxyCodeLine{00383\ \ \ \ \ \textcolor{comment}{//\ check\ proto\ checksum}}
\DoxyCodeLine{00384\ \ \ \ \ real\_protobuf\_checksum\ =}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacedoris_a77f99f60d5ebd163d89a71f4835d1cea}{olap\_adler32}}(\mbox{\hyperlink{olap_2utils_8h_a8b499a250e64eddf50a865b4c41fc21a}{ADLER32\_INIT}},\ buf.get(),\ \_fixed\_file\_header.protobuf\_length);}
\DoxyCodeLine{00386\ }
\DoxyCodeLine{00387\ \ \ \ \ \textcolor{keywordflow}{if}\ (real\_protobuf\_checksum\ !=\ \_fixed\_file\_header.protobuf\_checksum)\ \{}
\DoxyCodeLine{00388\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}checksum\ is\ not\ match.\ file="{}}\ <<\ file\_handler-\/>file\_name()}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ expect="{}}\ <<\ \_fixed\_file\_header.protobuf\_checksum}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ actual="{}}\ <<\ real\_protobuf\_checksum;}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::CHECKSUM\_ERROR>();}
\DoxyCodeLine{00392\ \ \ \ \ \}}
\DoxyCodeLine{00393\ }
\DoxyCodeLine{00394\ \ \ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \ \ std::string\ protobuf\_str(buf.get(),\ \_fixed\_file\_header.protobuf\_length);}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_proto.ParseFromString(protobuf\_str))\ \{}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ parse\ file\ content\ to\ protobuf\ object.\ file="{}}}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ file\_handler-\/>file\_name();}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::PARSE\_PROTOBUF\_ERROR>();}
\DoxyCodeLine{00401\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00402\ \ \ \ \ \}\ \textcolor{keywordflow}{catch}\ (...)\ \{}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ load\ protobuf.\ file='"{}}\ <<\ file\_handler-\/>file\_name();}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::PARSE\_PROTOBUF\_ERROR>();}
\DoxyCodeLine{00405\ \ \ \ \ \}}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00408\ \}}
\DoxyCodeLine{00409\ }
\DoxyCodeLine{00410\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ MessageType,\ \textcolor{keyword}{typename}\ ExtraType,\ \textcolor{keyword}{typename}\ FileHandlerType>}
\DoxyCodeLine{00411\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_file_header_a28c7532496270a7d14a5037b8abe81f6}{FileHeader<MessageType,\ ExtraType,\ FileHandlerType>::validate}}(\textcolor{keyword}{const}\ std::string\&\ filename)\ \{}
\DoxyCodeLine{00412\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_file_handler}{FileHandler}}\ file\_handler;}
\DoxyCodeLine{00413\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ res\ =\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\_handler.\mbox{\hyperlink{classdoris_1_1_file_handler_a366e3a81a2f35feafe297cc2a3a1d42a}{open}}(filename.c\_str(),\ O\_RDONLY))\ \{}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ errmsg[64];}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}fail\ to\ open\ file.\ [file='"{}}\ <<\ filename}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}'\ err="{}}\ <<\ strerror\_r(errno,\ errmsg,\ 64)\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::IO\_ERROR>();}
\DoxyCodeLine{00420\ \ \ \ \ \}}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{keywordflow}{if}\ (!(res\ =\ unserialize(\&file\_handler)))\ \{}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \ \ LOG(WARNING)\ <<\ \textcolor{stringliteral}{"{}unserialize\ file\ header\ error.\ [file='"{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}']"{}};}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ res;}
\DoxyCodeLine{00425\ \ \ \ \ \}}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00427\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00428\ \}}
\DoxyCodeLine{00429\ }
\DoxyCodeLine{00430\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
