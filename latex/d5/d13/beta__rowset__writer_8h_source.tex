\hypertarget{beta__rowset__writer_8h_source}{}\doxysection{beta\+\_\+rowset\+\_\+writer.\+h}
\label{beta__rowset__writer_8h_source}\index{/Users/dabowang/doris/be/src/olap/rowset/beta\_rowset\_writer.h@{/Users/dabowang/doris/be/src/olap/rowset/beta\_rowset\_writer.h}}
\mbox{\hyperlink{beta__rowset__writer_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{rowset__writer_8h}{olap/rowset/rowset\_writer.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{segcompaction_8h}{segcompaction.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{segment_8h}{segment\_v2/segment.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{column_8h}{vec/columns/column.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vertical__block__reader_8h}{vec/olap/vertical\_block\_reader.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vgeneric__iterators_8h}{vec/olap/vgeneric\_iterators.h}}"{}}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00028\ \textcolor{keyword}{namespace\ }segment\_v2\ \{}
\DoxyCodeLine{00029\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1segment__v2_1_1_segment_writer}{SegmentWriter}};}
\DoxyCodeLine{00030\ \}\ \textcolor{comment}{//\ namespace\ segment\_v2}}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \textcolor{keyword}{namespace\ }io\ \{}
\DoxyCodeLine{00033\ \textcolor{keyword}{class\ }FileWriter;}
\DoxyCodeLine{00034\ \}\ \textcolor{comment}{//\ namespace\ io}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \textcolor{keyword}{using\ }\mbox{\hyperlink{namespacedoris_a78d9bb2f3cac58b95b0b2fec6873ca87}{SegCompactionCandidates}}\ =\ std::vector<segment\_v2::SegmentSharedPtr>;}
\DoxyCodeLine{00037\ \textcolor{keyword}{using\ }\mbox{\hyperlink{namespacedoris_a56ea6d7b7fdfea379db2328f8c6c8fb3}{SegCompactionCandidatesSharedPtr}}\ =\ std::shared\_ptr<SegCompactionCandidates>;}
\DoxyCodeLine{00038\ \textcolor{keyword}{namespace\ }vectorized::schema\_util\ \{}
\DoxyCodeLine{00039\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1vectorized_1_1schema__util_1_1_local_schema_change_recorder}{LocalSchemaChangeRecorder}};}
\DoxyCodeLine{00040\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_beta_rowset_writer}{BetaRowsetWriter}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classdoris_1_1_rowset_writer}{RowsetWriter}}\ \{}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_segcompaction_worker}{SegcompactionWorker}};}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00046\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a25679ec3cf013db880ca8d5cdb55cca2}{BetaRowsetWriter}}();}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ae2442a106bbf73718bb667a079e40d31}{\string~BetaRowsetWriter}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a343d0b7751bf75d8a376fda3fe8c6471}{init}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structdoris_1_1_rowset_writer_context}{RowsetWriterContext}}\&\ rowset\_writer\_context)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6ebdc3271a059d2ce0dc936fa7afdc98}{add\_block}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{vectorized::Block}}*\ block)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{comment}{//\ add\ rowset\ by\ create\ hard\ link}}
\DoxyCodeLine{00055\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aebd76bf78fcd39cf9ee730cd1dc01b0e}{add\_rowset}}(\mbox{\hyperlink{namespacedoris_a45a11d2c52e9b86e26ff0bb6d9c667d2}{RowsetSharedPtr}}\ rowset)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aa6457f3f777e5b171b6b4b7d9f8b5b2c}{add\_rowset\_for\_linked\_schema\_change}}(\mbox{\hyperlink{namespacedoris_a45a11d2c52e9b86e26ff0bb6d9c667d2}{RowsetSharedPtr}}\ rowset)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ad79027858f888da67d94d9f46fb09db6}{flush}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{comment}{//\ Return\ the\ file\ size\ flushed\ to\ disk\ in\ "{}flush\_size"{}}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{comment}{//\ This\ method\ is\ thread-\/safe.}}
\DoxyCodeLine{00063\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a90bf2bf2d217c60cc9b223e8d038803c}{flush\_single\_memtable}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{vectorized::Block}}*\ block,\ int64\_t*\ flush\_size)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \ \ \mbox{\hyperlink{namespacedoris_a45a11d2c52e9b86e26ff0bb6d9c667d2}{RowsetSharedPtr}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_acf428e29464c852836f548de61c7aa4c}{build}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{comment}{//\ build\ a\ tmp\ rowset\ for\ load\ segment\ to\ calc\ delete\_bitmap}}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{comment}{//\ for\ this\ segment}}
\DoxyCodeLine{00069\ \ \ \ \ \mbox{\hyperlink{namespacedoris_a45a11d2c52e9b86e26ff0bb6d9c667d2}{RowsetSharedPtr}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a462e25329d9857bc1570cd164f94d3ac}{build\_tmp}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \mbox{\hyperlink{namespacedoris_a45a11d2c52e9b86e26ff0bb6d9c667d2}{RowsetSharedPtr}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_af5f9988de84052a099c0921d3120c8e0}{manual\_build}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacedoris_a8e1aa733e7ffe7bd29887ebdf7c1303d}{RowsetMetaSharedPtr}}\&\ rowset\_meta)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_version}{Version}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ad4e53d205365a6c7ffc53aa066b48deb}{version}}()\textcolor{keyword}{\ override\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6757ab922f6fd35123247d564e90f3dc}{\_context}}.\mbox{\hyperlink{structdoris_1_1_rowset_writer_context_ac620c19e22394db7bca83528aab69634}{version}};\ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a1f4426380f1dbfddda332d10240ce005}{num\_rows}}()\textcolor{keyword}{\ const\ override\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a8db6e37ba4fcad43075f96d3bb96437d}{\_raw\_num\_rows\_written}};\ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_rowset_id}{RowsetId}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a7cf94a6329b6b6bc10a1845f45efa667}{rowset\_id}}()\textcolor{keyword}{\ override\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6757ab922f6fd35123247d564e90f3dc}{\_context}}.\mbox{\hyperlink{structdoris_1_1_rowset_writer_context_a4453465a39aeab2456b4813be3936dca}{rowset\_id}};\ \}}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ RowsetTypePB\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_abd7a95f06e0daa31383f158500362cc5}{type}}()\textcolor{keyword}{\ const\ override\ }\{\ \textcolor{keywordflow}{return}\ RowsetTypePB::BETA\_ROWSET;\ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a25f9d6b5586d574e895a7ea4eb94422b}{get\_segment\_num\_rows}}(std::vector<uint32\_t>*\ segment\_num\_rows)\textcolor{keyword}{\ const\ override\ }\{}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ std::lock\_guard<SpinLock>\ l(\mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aaeda4b6262d10eb73734e61e27d42052}{\_lock}});}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ *segment\_num\_rows\ =\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a3280907607284d32f9beeeaab4c87581}{\_segment\_num\_rows}};}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00085\ \ \ \ \ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a9aa41573bdec986642a9e11b91e57402}{get\_atomic\_num\_segment}}()\textcolor{keyword}{\ const\ override\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a9c49f6b06ab7387540564862dd0792b6}{\_num\_segment}}.load();\ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ Maybe\ modified\ by\ local\ schema\ change}}
\DoxyCodeLine{00090\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1schema__util_1_1_local_schema_change_recorder}{vectorized::schema\_util::LocalSchemaChangeRecorder}}*\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ae5271c6822cb1d67e86063d301556b54}{mutable\_schema\_change\_recorder}}()\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6757ab922f6fd35123247d564e90f3dc}{\_context}}.\mbox{\hyperlink{structdoris_1_1_rowset_writer_context_a743e59d6a13ac53ede5fdba2274f3043}{schema\_change\_recorder}}.get();}
\DoxyCodeLine{00092\ \ \ \ \ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_afa1cf8cc5743dcd7c54b162b2bfa69b0}{get\_num\_mow\_keys}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aea907a695f6334e2b6e75a51d352c6f4}{\_num\_mow\_keys}};\ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_segcompaction_worker}{SegcompactionWorker}}\&\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ab1c15fcad84ea2749453d3714a4d3ccb}{get\_segcompaction\_worker}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a0821dd5e32ad0688deb39f6a4f7c0cf8}{\_segcompaction\_worker}};\ \}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a51a84059bc18c986f7071e57ec2b7614}{flush\_segment\_writer\_for\_segcompaction}}(}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_ptr<segment\_v2::SegmentWriter>*\ writer,\ uint64\_t\ index\_size,}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ KeyBoundsPB\&\ key\_bounds);}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ad351b56c44bac6e0b9624d9e078172c4}{is\_doing\_segcompaction}}()\textcolor{keyword}{\ const\ override\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_adb7e71e708f8835f13bc8a0778e5def5}{\_is\_doing\_segcompaction}};\ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aebe7294fcc8e8965b035b44fe994ce7d}{wait\_flying\_segcompaction}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00107\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a333c93bb680d65bc4c23d50527f2fc84}{\_add\_block}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{vectorized::Block}}*\ block,}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::unique\_ptr<segment\_v2::SegmentWriter>*\ writer);}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ac9b102757a670226bafed17fa90c8291}{\_do\_create\_segment\_writer}}(std::unique\_ptr<segment\_v2::SegmentWriter>*\ writer,}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_segcompaction,\ int64\_t\ begin,\ int64\_t\ end,}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{vectorized::Block}}*\ block\ =\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00113\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a63835a01ec764ec799ee33bde54e5ae0}{\_create\_segment\_writer}}(std::unique\_ptr<segment\_v2::SegmentWriter>*\ writer,}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{vectorized::Block}}*\ block\ =\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00115\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aea0c10b42df947b1034807b00a236ab2}{\_flush\_segment\_writer}}(std::unique\_ptr<segment\_v2::SegmentWriter>*\ writer,}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ int64\_t*\ flush\_size\ =\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a3d38543fc3866db5347f97915c29cb6d}{\_build\_rowset\_meta}}(std::shared\_ptr<RowsetMeta>\ rowset\_meta);}
\DoxyCodeLine{00118\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aa3d5f49a59fd19516269465dd693dd71}{\_segcompaction\_if\_necessary}}();}
\DoxyCodeLine{00119\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a84396a1034def3d4bfcbccaf2697b687}{\_segcompaction\_ramaining\_if\_necessary}}();}
\DoxyCodeLine{00120\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_abb72d2cc5296c4b27f4b5a94b3c396d4}{\_load\_noncompacted\_segments}}(std::vector<segment\_v2::SegmentSharedPtr>*\ segments,}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ num);}
\DoxyCodeLine{00122\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a038bf1797be18e0869ac94d4932d6661}{\_find\_longest\_consecutive\_small\_segment}}(\mbox{\hyperlink{namespacedoris_a56ea6d7b7fdfea379db2328f8c6c8fb3}{SegCompactionCandidatesSharedPtr}}\ segments);}
\DoxyCodeLine{00123\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a322f0193a1597264cd2efca4315538a1}{\_get\_segcompaction\_candidates}}(\mbox{\hyperlink{namespacedoris_a56ea6d7b7fdfea379db2328f8c6c8fb3}{SegCompactionCandidatesSharedPtr}}\&\ segments,\ \textcolor{keywordtype}{bool}\ is\_last);}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a80c4cf4f882a890459eb762351094ba1}{\_is\_segcompacted}}()\ \{\ \textcolor{keywordflow}{return}\ (\mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a491363bb66fa9738e6f6fdac32b178c1}{\_num\_segcompacted}}\ >\ 0)\ ?\ true\ :\ \textcolor{keyword}{false};\ \}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ad4d7e234e3ecac7fe90666c705f99193}{\_check\_and\_set\_is\_doing\_segcompaction}}();}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a8ccaa38dc540980ce953d517343fc96a}{\_build\_rowset\_meta\_with\_spec\_field}}(\mbox{\hyperlink{namespacedoris_a8e1aa733e7ffe7bd29887ebdf7c1303d}{RowsetMetaSharedPtr}}\ rowset\_meta,}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespacedoris_a8e1aa733e7ffe7bd29887ebdf7c1303d}{RowsetMetaSharedPtr}}\&\ spec\_rowset\_meta);}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a965ad47c23348ce33e128dec3d0ceaaa}{\_is\_segment\_overlapping}}(\textcolor{keyword}{const}\ std::vector<KeyBoundsPB>\&\ segments\_encoded\_key\_bounds);}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a0c8ad919f8bee7b57c58b1c8be4e83f4}{\_clear\_statistics\_for\_deleting\_segments\_unsafe}}(uint64\_t\ begin,\ uint64\_t\ end);}
\DoxyCodeLine{00132\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6f403eb655ab0cb9d3c6f85f6aaf6e58}{\_rename\_compacted\_segments}}(int64\_t\ begin,\ int64\_t\ end);}
\DoxyCodeLine{00133\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a55c7190152c4eee1f380554612cbf010}{\_rename\_compacted\_segment\_plain}}(uint64\_t\ seg\_id);}
\DoxyCodeLine{00134\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a46d6a566f2ec70d926c1904bce1fdc03}{\_rename\_compacted\_indices}}(int64\_t\ begin,\ int64\_t\ end,\ uint64\_t\ seg\_id);}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00137\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_rowset_writer_context}{RowsetWriterContext}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6757ab922f6fd35123247d564e90f3dc}{\_context}};}
\DoxyCodeLine{00138\ \ \ \ \ std::shared\_ptr<RowsetMeta>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a3bb95449af96da0ce20e37f70ea978ef}{\_rowset\_meta}};}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ std::atomic<int32\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a9c49f6b06ab7387540564862dd0792b6}{\_num\_segment}};}
\DoxyCodeLine{00141\ \ \ \ \ std::atomic<int32\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ad8343495b283b651d1b36ea5812bdd98}{\_num\_flushed\_segment}};}
\DoxyCodeLine{00142\ \ \ \ \ std::atomic<int32\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a09e9793ca82402b8994e046340cac9c2}{\_segcompacted\_point}};\ \textcolor{comment}{//\ segemnts\ before\ this\ point\ have}}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ already\ been\ segment\ compacted}}
\DoxyCodeLine{00144\ \ \ \ \ std::atomic<int32\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a491363bb66fa9738e6f6fdac32b178c1}{\_num\_segcompacted}};\ \ \ \textcolor{comment}{//\ index\ for\ segment\ compaction}}
\DoxyCodeLine{00148\ \textcolor{comment}{}\ \ \ \ std::unique\_ptr<segment\_v2::SegmentWriter>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a9a334f8317ca9ebedc6cfd1732960535}{\_segment\_writer}};}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keyword}{mutable}\ \mbox{\hyperlink{classdoris_1_1_spin_lock}{SpinLock}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aaeda4b6262d10eb73734e61e27d42052}{\_lock}};\ \textcolor{comment}{//\ protect\ following\ vectors.}}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{comment}{//\ record\ rows\ number\ of\ every\ segment\ already\ written,\ using\ for\ rowid}}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{comment}{//\ conversion\ when\ compaction\ in\ unique\ key\ with\ MoW\ model}}
\DoxyCodeLine{00153\ \ \ \ \ std::vector<uint32\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a3280907607284d32f9beeeaab4c87581}{\_segment\_num\_rows}};}
\DoxyCodeLine{00154\ \ \ \ \ std::vector<io::FileWriterPtr>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a9355f7b3c71db83fe39b4f372afa6b03}{\_file\_writers}};}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{comment}{//\ for\ unique\ key\ table\ with\ merge-\/on-\/write}}
\DoxyCodeLine{00156\ \ \ \ \ std::vector<KeyBoundsPB>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a86373d346df1da2e0269953a9f066f97}{\_segments\_encoded\_key\_bounds}};}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{comment}{//\ counters\ and\ statistics\ maintained\ during\ add\_rowset}}
\DoxyCodeLine{00159\ \ \ \ \ std::atomic<int64\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a6579d5ccf12b5937c8b4dfc868029b76}{\_num\_rows\_written}};}
\DoxyCodeLine{00160\ \ \ \ \ std::atomic<int64\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_ac6757182f47c0fdc1acdd3ce05b464b8}{\_total\_data\_size}};}
\DoxyCodeLine{00161\ \ \ \ \ std::atomic<int64\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aa8fd0766439b77886c83a6d9972b45e8}{\_total\_index\_size}};}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ TODO\ rowset\ Zonemap}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{comment}{//\ written\ rows\ by\ add\_block/add\_row\ (not\ effected\ by\ segcompaction)}}
\DoxyCodeLine{00165\ \ \ \ \ std::atomic<int64\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a8db6e37ba4fcad43075f96d3bb96437d}{\_raw\_num\_rows\_written}};}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1_beta_rowset_writer_1_1_statistics}{Statistics}}\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ int64\_t\ \mbox{\hyperlink{structdoris_1_1_beta_rowset_writer_1_1_statistics_a74e1f818e2f738f73313d35fa6071ded}{row\_num}};}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ int64\_t\ \mbox{\hyperlink{structdoris_1_1_beta_rowset_writer_1_1_statistics_a716c829ad81d200cbd4d08c0be5d8d02}{data\_size}};}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ int64\_t\ \mbox{\hyperlink{structdoris_1_1_beta_rowset_writer_1_1_statistics_a2c501ea62f8d32ddb7867ee6d9d11400}{index\_size}};}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ KeyBoundsPB\ \mbox{\hyperlink{structdoris_1_1_beta_rowset_writer_1_1_statistics_ab7533e55f7e255c8a2447086f90c19fd}{key\_bounds}};}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ std::shared\_ptr<std::unordered\_set<std::string>>\ \mbox{\hyperlink{structdoris_1_1_beta_rowset_writer_1_1_statistics_a4aa825328164eed69323ec86ffc6c929}{key\_set}};}
\DoxyCodeLine{00173\ \ \ \ \ \};}
\DoxyCodeLine{00174\ \ \ \ \ std::mutex\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a4fe2237ec28abb9cd707348f8be58d40}{\_segid\_statistics\_map\_mutex}};}
\DoxyCodeLine{00175\ \ \ \ \ std::map<uint32\_t,\ Statistics>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a293650ac5d2b531bb75aec5889c3ab8a}{\_segid\_statistics\_map}};}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{comment}{//\ used\ for\ check\ correctness\ of\ unique\ key\ mow\ keys.}}
\DoxyCodeLine{00178\ \ \ \ \ std::atomic<uint64\_t>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aea907a695f6334e2b6e75a51d352c6f4}{\_num\_mow\_keys}};}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a1692c15e0af86cbc5e360ffc5b07830c}{\_is\_pending}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a90ed18711db4500fda86421963a1eaa4}{\_already\_built}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_segcompaction_worker}{SegcompactionWorker}}\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a0821dd5e32ad0688deb39f6a4f7c0cf8}{\_segcompaction\_worker}};}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{comment}{//\ ensure\ only\ one\ inflight\ segcompaction\ task\ for\ each\ rowset}}
\DoxyCodeLine{00186\ \ \ \ \ std::atomic<bool>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_adb7e71e708f8835f13bc8a0778e5def5}{\_is\_doing\_segcompaction}};}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{comment}{//\ enforce\ compare-\/and-\/swap\ on\ \_is\_doing\_segcompaction}}
\DoxyCodeLine{00188\ \ \ \ \ std::mutex\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a866ee54882fd62dffbbbf2f5333bee30}{\_is\_doing\_segcompaction\_lock}};}
\DoxyCodeLine{00189\ \ \ \ \ std::condition\_variable\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_aad5debccba2447c9d2f0efc31f9c4dea}{\_segcompacting\_cond}};}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \ \ std::atomic<int>\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a1f7755d6c244692106d65c697a59f046}{\_segcompaction\_status}};}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \ \ fmt::memory\_buffer\ \mbox{\hyperlink{classdoris_1_1_beta_rowset_writer_a89b5092b10e512bf70bc146d86099103}{vlog\_buffer}};}
\DoxyCodeLine{00194\ \};}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
