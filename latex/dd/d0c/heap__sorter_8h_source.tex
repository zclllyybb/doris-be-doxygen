\hypertarget{heap__sorter_8h_source}{}\doxysection{heap\+\_\+sorter.\+h}
\label{heap__sorter_8h_source}\index{/Users/dabowang/be\_all/vec/common/sort/heap\_sorter.h@{/Users/dabowang/be\_all/vec/common/sort/heap\_sorter.h}}
\mbox{\hyperlink{heap__sorter_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <queue>}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sorter_8h}{vec/common/sort/sorter.h}}"{}}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris_1_1vectorized}{doris::vectorized}}\ \{}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap}{SortingHeap}}\ \{}
\DoxyCodeLine{00026\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structdoris_1_1vectorized_1_1_heap_sort_cursor_impl}{HeapSortCursorImpl}}\&\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a83a7cfc5f635644ab88779b4a0a80cc4}{top}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.top();\ \}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a0b6b70701c46e22849f0f363861351cd}{size}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.size();\ \}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a3f37b042a1e7cd4bd38fc564de81f0da}{empty}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.empty();\ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a312e7f6c761a199c1369fbe651e084f0}{pop}}()\ \{\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.pop();\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_aba540cdd3856095ca365bbf50f03e519}{replace\_top}}(\mbox{\hyperlink{structdoris_1_1vectorized_1_1_heap_sort_cursor_impl}{HeapSortCursorImpl}}\&\&\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a83a7cfc5f635644ab88779b4a0a80cc4}{top}})\ \{}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.pop();}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.push(std::move(\mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a83a7cfc5f635644ab88779b4a0a80cc4}{top}}));}
\DoxyCodeLine{00038\ \ \ \ \ \}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_ad5c437f1ed95958bdf8c11c865192768}{push}}(\mbox{\hyperlink{structdoris_1_1vectorized_1_1_heap_sort_cursor_impl}{HeapSortCursorImpl}}\&\&\ cursor)\ \{\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}}.push(std::move(cursor));\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_afddd47ac394fd3095047a38eb353571a}{replace\_top\_if\_less}}(\mbox{\hyperlink{structdoris_1_1vectorized_1_1_heap_sort_cursor_impl}{HeapSortCursorImpl}}\&\&\ val)\ \{}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (val\ <\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a83a7cfc5f635644ab88779b4a0a80cc4}{top}}())\ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_aba540cdd3856095ca365bbf50f03e519}{replace\_top}}(std::move(val));}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00046\ \ \ \ \ \}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00049\ \ \ \ \ std::priority\_queue<HeapSortCursorImpl>\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorting_heap_a930c92584552ff2de4cf18a08431f932}{\_queue}};}
\DoxyCodeLine{00050\ \};}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter}{HeapSorter}}\ final\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_sorter}{Sorter}}\ \{}
\DoxyCodeLine{00053\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00054\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter}{HeapSorter}}(\mbox{\hyperlink{classdoris_1_1vectorized_1_1_v_sort_exec_exprs}{VSortExecExprs}}\&\ vsort\_exec\_exprs,\ \textcolor{keywordtype}{int}\ limit,\ int64\_t\ offset,\ \mbox{\hyperlink{classdoris_1_1_object_pool}{ObjectPool}}*\ pool,}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<bool>\&\ is\_asc\_order,\ std::vector<bool>\&\ nulls\_first,}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1_row_descriptor}{RowDescriptor}}\&\ row\_desc);}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a6e28749c6ae58dae87752a71db7b83bd}{\string~HeapSorter}}()\ \textcolor{keyword}{override}\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a8b694c0a4ddafd6524913310758c96e1}{init\_profile}}(\mbox{\hyperlink{classdoris_1_1_runtime_profile}{RuntimeProfile}}*\ runtime\_profile)\textcolor{keyword}{\ override\ }\{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a691095530295eaf8fd65cf91e3aaf10e}{\_topn\_filter\_timer}}\ =\ \mbox{\hyperlink{runtime__profile_8h_a8841ca205b2a05d608e82d443bad3a77}{ADD\_TIMER}}(runtime\_profile,\ \textcolor{stringliteral}{"{}TopNFilterTime"{}});}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_af81edc131eefaa4f35c1a95bd71182a4}{\_topn\_filter\_rows\_counter}}\ =\ \mbox{\hyperlink{runtime__profile_8h_a1c98350069ee6cbc67be687f272e571b}{ADD\_COUNTER}}(runtime\_profile,\ \textcolor{stringliteral}{"{}TopNFilterRows"{}},\ TUnit::UNIT);}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_ae572c491dabe4c6d13a81cdcd3174450}{\_materialize\_timer}}\ =\ \mbox{\hyperlink{runtime__profile_8h_a8841ca205b2a05d608e82d443bad3a77}{ADD\_TIMER}}(runtime\_profile,\ \textcolor{stringliteral}{"{}MaterializeTime"{}});}
\DoxyCodeLine{00064\ \ \ \ \ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a512f5b888294154eb87437bae703fafc}{append\_block}}(\mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}*\ block)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a87a7d923391a271ee8ddcce33856679d}{prepare\_for\_read}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a919ab1c222d6846eb6395f8b2bdc880b}{get\_next}}(\mbox{\hyperlink{classdoris_1_1_runtime_state}{RuntimeState}}*\ state,\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}*\ block,\ \textcolor{keywordtype}{bool}*\ eos)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a3fd226de50969f514797b6458598ae69}{data\_size}}()\ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_field}{Field}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a6f21ca173dc5ef3834891fb9d0f11340}{get\_top\_value}}()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a6d5b660282528bbdaf6fc718a582e142}{HEAP\_SORT\_THRESHOLD}}\ =\ 1024;}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_ad557ded364f95ff9e6dd2c4feac68985}{\_do\_filter}}(\mbox{\hyperlink{structdoris_1_1vectorized_1_1_heap_sort_cursor_block_view}{HeapSortCursorBlockView}}\&\ block\_view,\ \textcolor{keywordtype}{size\_t}\ num\_rows);}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_ad8a374498363215c9c7f14c3b9af41c3}{\_prepare\_sort\_descs}}(\mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}*\ block);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a58ea1b4b0614eaf64fdba64743d65d86}{\_data\_size}};}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_abe2eab917efac8c5ea5389d5d69ccc56}{\_heap\_size}};}
\DoxyCodeLine{00085\ \ \ \ \ std::unique\_ptr<SortingHeap>\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a3e4fafa274c2c1941c6a97c0c73beb1d}{\_heap}};}
\DoxyCodeLine{00086\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_ad105aae90c436e4c5cac23aba1a79110}{\_return\_block}};}
\DoxyCodeLine{00087\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a3b0078e0f12b001ad49f10da9117e2ec}{\_topn\_filter\_rows}};}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_af6be421cf1a65c8146a8c40bba9f9509}{\_init\_sort\_descs}};}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile_1_1_counter}{RuntimeProfile::Counter}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_a691095530295eaf8fd65cf91e3aaf10e}{\_topn\_filter\_timer}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00091\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile_1_1_counter}{RuntimeProfile::Counter}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_af81edc131eefaa4f35c1a95bd71182a4}{\_topn\_filter\_rows\_counter}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00092\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile_1_1_counter}{RuntimeProfile::Counter}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_heap_sorter_ae572c491dabe4c6d13a81cdcd3174450}{\_materialize\_timer}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00093\ \};}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \}\ \textcolor{comment}{//\ namespace\ doris::vectorized}}

\end{DoxyCode}
