\hypertarget{page__io_8h_source}{}\doxysection{page\+\_\+io.\+h}
\label{page__io_8h_source}\index{/Users/dabowang/doris/be/src/olap/rowset/segment\_v2/page\_io.h@{/Users/dabowang/doris/be/src/olap/rowset/segment\_v2/page\_io.h}}
\mbox{\hyperlink{page__io_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{logging_8h}{common/logging.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{status_8h}{common/status.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}gen\_cpp/segment\_v2.pb.h"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{file__reader_8h}{io/fs/file\_reader.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{iterators_8h}{olap/iterators.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{encoding__info_8h}{olap/rowset/segment\_v2/encoding\_info.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{page__handle_8h}{olap/rowset/segment\_v2/page\_handle.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{page__pointer_8h}{olap/rowset/segment\_v2/page\_pointer.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{slice_8h}{util/slice.h}}"{}}}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \textcolor{keyword}{class\ }BlockCompressionCodec;}
\DoxyCodeLine{00035\ \textcolor{keyword}{struct\ }OlapReaderStatistics;}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{keyword}{namespace\ }fs\ \{}
\DoxyCodeLine{00038\ \textcolor{keyword}{class\ }ReadableBlock;}
\DoxyCodeLine{00039\ \textcolor{keyword}{class\ }WritableBlock;}
\DoxyCodeLine{00040\ \}\ \textcolor{comment}{//\ namespace\ fs}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{keyword}{namespace\ }io\ \{}
\DoxyCodeLine{00043\ \textcolor{keyword}{class\ }FileWriter;}
\DoxyCodeLine{00044\ \}\ \textcolor{comment}{//\ namespace\ io}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \textcolor{keyword}{namespace\ }segment\_v2\ \{}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options}{PageReadOptions}}\ \{}
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{comment}{//\ block\ to\ read\ page}}
\DoxyCodeLine{00050\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1io_1_1_file_reader}{io::FileReader}}*\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a5e866c637e73f9240fa87a568b0e4aeb}{file\_reader}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{comment}{//\ location\ of\ the\ page}}
\DoxyCodeLine{00052\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_pointer}{PagePointer}}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a4e568c90b7190918ed645772af957059}{page\_pointer}};}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{//\ decompressor\ for\ page\ body\ (null\ means\ page\ body\ is\ not\ compressed)}}
\DoxyCodeLine{00054\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_block_compression_codec}{BlockCompressionCodec}}*\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a247a3d1477bd6cc826fbd3d90d1b5bee}{codec}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{comment}{//\ used\ to\ collect\ IO\ metrics}}
\DoxyCodeLine{00056\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_olap_reader_statistics}{OlapReaderStatistics}}*\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_ac963dd6093bb0abb6ad25d40ec6ea014}{stats}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{comment}{//\ whether\ to\ verify\ page\ checksum}}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a2c629d19f626d942146477096ed95a98}{verify\_checksum}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{comment}{//\ whether\ to\ use\ page\ cache\ in\ read\ path}}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_ac6da75faea521a74cec8c389bab29b40}{use\_page\_cache}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{comment}{//\ if\ true,\ use\ DURABLE\ CachePriority\ in\ page\ cache}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{comment}{//\ currently\ used\ for\ in\ memory\ olap\ table}}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_aa49e53d217ba587fe754e7d21f73d0e8}{kept\_in\_memory}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{comment}{//\ for\ page\ cache\ allocation}}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{comment}{//\ page\ types\ are\ divided\ into\ DATA\_PAGE\ \&\ INDEX\_PAGE}}
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{comment}{//\ INDEX\_PAGE\ including\ index\_page,\ dict\_page\ and\ short\_key\_page}}
\DoxyCodeLine{00067\ \ \ \ \ PageTypePB\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_aea3b731dc287650f7816cf399ae60e7f}{type}};}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_encoding_info}{EncodingInfo}}*\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a62014fcec054cf0ce8a8868ec97a12fa}{encoding\_info}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ index\_page\ should\ not\ be\ pre-\/decoded}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_ae4211052208e28079b565aea1bfb8d55}{pre\_decode}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1io_1_1_i_o_context}{io::IOContext}}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a0807972b96ec74887db8958ac1326869}{io\_ctx}};}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a9212de80cb74786d98056090825d1496}{sanity\_check}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ CHECK\_NOTNULL(\mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_a5e866c637e73f9240fa87a568b0e4aeb}{file\_reader}});}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ CHECK\_NOTNULL(\mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options_ac963dd6093bb0abb6ad25d40ec6ea014}{stats}});}
\DoxyCodeLine{00079\ \ \ \ \ \}}
\DoxyCodeLine{00080\ \};}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \textcolor{comment}{//\ Utility\ class\ for\ read\ and\ write\ page.\ All\ types\ of\ page\ share\ the\ same\ general\ layout:}}
\DoxyCodeLine{00083\ \textcolor{comment}{//\ \ \ \ \ Page\ :=\ PageBody,\ PageFooter,\ FooterSize(4),\ Checksum(4)}}
\DoxyCodeLine{00084\ \textcolor{comment}{//\ \ \ \ \ -\/\ PageBody\ is\ defined\ by\ page\ type\ and\ may\ be\ compressed}}
\DoxyCodeLine{00085\ \textcolor{comment}{//\ \ \ \ \ -\/\ PageFooter\ is\ serialized\ PageFooterPB.\ It\ contains\ page\_type,\ uncompressed\_body\_size,}}
\DoxyCodeLine{00086\ \textcolor{comment}{//\ \ \ \ \ \ \ and\ other\ custom\ metadata.\ PageBody\ is\ not\ compressed\ when\ its\ size\ is\ equal\ to}}
\DoxyCodeLine{00087\ \textcolor{comment}{//\ \ \ \ \ \ \ uncompressed\_body\_size}}
\DoxyCodeLine{00088\ \textcolor{comment}{//\ \ \ \ \ -\/\ FooterSize\ stores\ the\ size\ of\ PageFooter}}
\DoxyCodeLine{00089\ \textcolor{comment}{//\ \ \ \ \ -\/\ Checksum\ is\ the\ crc32c\ checksum\ of\ all\ previous\ part}}
\DoxyCodeLine{00090\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o}{PageIO}}\ \{}
\DoxyCodeLine{00091\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{comment}{//\ Compress\ `body'\ using\ `codec'\ into\ `compressed\_body'.}}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{comment}{//\ The\ size\ of\ returned\ `compressed\_body'\ is\ 0\ when\ the\ body\ is\ not\ compressed,\ this}}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{comment}{//\ could\ happen\ when\ `codec'\ is\ null\ or\ space\ saving\ is\ less\ than\ `min\_space\_saving'.}}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_af3f734d1d94dffbde8821be64783b2cc}{compress\_page\_body}}(\mbox{\hyperlink{classdoris_1_1_block_compression_codec}{BlockCompressionCodec}}*\ codec,\ \textcolor{keywordtype}{double}\ min\_space\_saving,}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::vector<Slice>\&\ body,\ \mbox{\hyperlink{classdoris_1_1_owned_slice}{OwnedSlice}}*\ compressed\_body);}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{comment}{//\ Encode\ page\ from\ `body'\ and\ `footer'\ and\ write\ to\ `file'.}}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{comment}{//\ `body'\ could\ be\ either\ uncompressed\ or\ compressed.}}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{comment}{//\ On\ success,\ the\ file\ pointer\ to\ the\ written\ page\ is\ stored\ in\ `result'.}}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_acbe06b7c0a36ecfd9bc3ed341aa06d40}{write\_page}}(\mbox{\hyperlink{classdoris_1_1io_1_1_file_writer}{io::FileWriter}}*\ writer,\ \textcolor{keyword}{const}\ std::vector<Slice>\&\ body,}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ PageFooterPB\&\ footer,\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_pointer}{PagePointer}}*\ result);}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{comment}{//\ Convenient\ function\ to\ compress\ page\ body\ and\ write\ page\ in\ one\ go.}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_a54512ab6ad76c0993acfa4958f3b07d3}{compress\_and\_write\_page}}(\mbox{\hyperlink{classdoris_1_1_block_compression_codec}{BlockCompressionCodec}}*\ codec,\ \textcolor{keywordtype}{double}\ min\_space\_saving,}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1io_1_1_file_writer}{io::FileWriter}}*\ writer,\ \textcolor{keyword}{const}\ std::vector<Slice>\&\ body,}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ PageFooterPB\&\ footer,\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_pointer}{PagePointer}}*\ result)\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ DCHECK\_EQ(footer.uncompressed\_size(),\ \mbox{\hyperlink{structdoris_1_1_slice_ace80696f691737ab717623c59a5532d7}{Slice::compute\_total\_size}}(body));}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_owned_slice}{OwnedSlice}}\ compressed\_body;}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{status_8h_a85f7d0e774e15eb35b74f53264305e16}{RETURN\_IF\_ERROR}}(\mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_af3f734d1d94dffbde8821be64783b2cc}{compress\_page\_body}}(codec,\ min\_space\_saving,\ body,\ \&compressed\_body));}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (compressed\_body.\mbox{\hyperlink{classdoris_1_1_owned_slice_a77d86aa3e0373dba1c5e9ca9638583fb}{slice}}().\mbox{\hyperlink{structdoris_1_1_slice_a644718bb2fb240de962dc3c9a1fdf0dc}{empty}}())\ \{\ \textcolor{comment}{//\ uncompressed}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_acbe06b7c0a36ecfd9bc3ed341aa06d40}{write\_page}}(writer,\ body,\ footer,\ result);}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_acbe06b7c0a36ecfd9bc3ed341aa06d40}{write\_page}}(writer,\ \{compressed\_body.\mbox{\hyperlink{classdoris_1_1_owned_slice_a77d86aa3e0373dba1c5e9ca9638583fb}{slice}}()\},\ footer,\ result);}
\DoxyCodeLine{00115\ \ \ \ \ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{comment}{//\ Read\ and\ parse\ a\ page\ according\ to\ `opts'.}}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{comment}{//\ On\ success}}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ `handle'\ holds\ the\ memory\ of\ page\ data,}}
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ `body'\ points\ to\ page\ body,}}
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ `footer'\ stores\ the\ page\ footer.}}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_i_o_aa57e6175df0a6154aa6179ae22682350}{read\_and\_decompress\_page}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structdoris_1_1segment__v2_1_1_page_read_options}{PageReadOptions}}\&\ opts,\ \mbox{\hyperlink{classdoris_1_1segment__v2_1_1_page_handle}{PageHandle}}*\ handle,}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_slice}{Slice}}*\ body,\ PageFooterPB*\ footer);}
\DoxyCodeLine{00124\ \};}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \}\ \textcolor{comment}{//\ namespace\ segment\_v2}}
\DoxyCodeLine{00127\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
