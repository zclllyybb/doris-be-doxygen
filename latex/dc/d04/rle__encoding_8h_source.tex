\hypertarget{rle__encoding_8h_source}{}\doxysection{rle\+\_\+encoding.\+h}
\label{rle__encoding_8h_source}\index{/Users/dabowang/doris/be/src/util/rle\_encoding.h@{/Users/dabowang/doris/be/src/util/rle\_encoding.h}}
\mbox{\hyperlink{rle__encoding_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <glog/logging.h>}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{port_8h}{gutil/port.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bit__stream__utils_8inline_8h}{util/bit\_stream\_utils.inline.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bit__util_8h}{util/bit\_util.h}}"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{comment}{//\ Utility\ classes\ to\ do\ run\ length\ encoding\ (RLE)\ for\ fixed\ bit\ width\ values.\ \ If\ runs}}
\DoxyCodeLine{00028\ \textcolor{comment}{//\ are\ sufficiently\ long,\ RLE\ is\ used,\ otherwise,\ the\ values\ are\ just\ bit-\/packed}}
\DoxyCodeLine{00029\ \textcolor{comment}{//\ (literal\ encoding).}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\ For\ both\ types\ of\ runs,\ there\ is\ a\ byte-\/aligned\ indicator\ which\ encodes\ the\ length}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ of\ the\ run\ and\ the\ type\ of\ the\ run.}}
\DoxyCodeLine{00032\ \textcolor{comment}{//\ This\ encoding\ has\ the\ benefit\ that\ when\ there\ aren't\ any\ long\ enough\ runs,\ values}}
\DoxyCodeLine{00033\ \textcolor{comment}{//\ are\ always\ decoded\ at\ fixed\ (can\ be\ precomputed)\ bit\ offsets\ OR\ both\ the\ value\ and}}
\DoxyCodeLine{00034\ \textcolor{comment}{//\ the\ run\ length\ are\ byte\ aligned.\ This\ allows\ for\ very\ efficient\ decoding}}
\DoxyCodeLine{00035\ \textcolor{comment}{//\ implementations.}}
\DoxyCodeLine{00036\ \textcolor{comment}{//\ The\ encoding\ is:}}
\DoxyCodeLine{00037\ \textcolor{comment}{//\ \ \ \ encoded-\/block\ :=\ run*}}
\DoxyCodeLine{00038\ \textcolor{comment}{//\ \ \ \ run\ :=\ literal-\/run\ |\ repeated-\/run}}
\DoxyCodeLine{00039\ \textcolor{comment}{//\ \ \ \ literal-\/run\ :=\ literal-\/indicator\ <\ literal\ bytes\ >}}
\DoxyCodeLine{00040\ \textcolor{comment}{//\ \ \ \ repeated-\/run\ :=\ repeated-\/indicator\ <\ repeated\ value.\ padded\ to\ byte\ boundary\ >}}
\DoxyCodeLine{00041\ \textcolor{comment}{//\ \ \ \ literal-\/indicator\ :=\ varint\_encode(\ number\_of\_groups\ <<\ 1\ |\ 1)}}
\DoxyCodeLine{00042\ \textcolor{comment}{//\ \ \ \ repeated-\/indicator\ :=\ varint\_encode(\ number\_of\_repetitions\ <<\ 1\ )}}
\DoxyCodeLine{00043\ \textcolor{comment}{//}}
\DoxyCodeLine{00044\ \textcolor{comment}{//\ Each\ run\ is\ preceded\ by\ a\ varint.\ The\ varint's\ least\ significant\ bit\ is}}
\DoxyCodeLine{00045\ \textcolor{comment}{//\ used\ to\ indicate\ whether\ the\ run\ is\ a\ literal\ run\ or\ a\ repeated\ run.\ The\ rest}}
\DoxyCodeLine{00046\ \textcolor{comment}{//\ of\ the\ varint\ is\ used\ to\ determine\ the\ length\ of\ the\ run\ (eg\ how\ many\ times\ the}}
\DoxyCodeLine{00047\ \textcolor{comment}{//\ value\ repeats).}}
\DoxyCodeLine{00048\ \textcolor{comment}{//}}
\DoxyCodeLine{00049\ \textcolor{comment}{//\ In\ the\ case\ of\ literal\ runs,\ the\ run\ length\ is\ always\ a\ multiple\ of\ 8\ (i.e.\ encode}}
\DoxyCodeLine{00050\ \textcolor{comment}{//\ in\ groups\ of\ 8),\ so\ that\ no\ matter\ the\ bit-\/width\ of\ the\ value,\ the\ sequence\ will\ end}}
\DoxyCodeLine{00051\ \textcolor{comment}{//\ on\ a\ byte\ boundary\ without\ padding.}}
\DoxyCodeLine{00052\ \textcolor{comment}{//\ Given\ that\ we\ know\ it\ is\ a\ multiple\ of\ 8,\ we\ store\ the\ number\ of\ 8-\/groups\ rather\ than}}
\DoxyCodeLine{00053\ \textcolor{comment}{//\ the\ actual\ number\ of\ encoded\ ints.\ (This\ means\ that\ the\ total\ number\ of\ encoded\ values}}
\DoxyCodeLine{00054\ \textcolor{comment}{//\ can\ not\ be\ determined\ from\ the\ encoded\ data,\ since\ the\ number\ of\ values\ in\ the\ last}}
\DoxyCodeLine{00055\ \textcolor{comment}{//\ group\ may\ not\ be\ a\ multiple\ of\ 8).}}
\DoxyCodeLine{00056\ \textcolor{comment}{//\ There\ is\ a\ break-\/even\ point\ when\ it\ is\ more\ storage\ efficient\ to\ do\ run\ length}}
\DoxyCodeLine{00057\ \textcolor{comment}{//\ encoding.\ \ For\ 1\ bit-\/width\ values,\ that\ point\ is\ 8\ values.\ \ They\ require\ 2\ bytes}}
\DoxyCodeLine{00058\ \textcolor{comment}{//\ for\ both\ the\ repeated\ encoding\ or\ the\ literal\ encoding.\ \ This\ value\ can\ always}}
\DoxyCodeLine{00059\ \textcolor{comment}{//\ be\ computed\ based\ on\ the\ bit-\/width.}}
\DoxyCodeLine{00060\ \textcolor{comment}{//\ TODO:\ think\ about\ how\ to\ use\ this\ for\ strings.\ \ The\ bit\ packing\ isn't\ quite\ the\ same.}}
\DoxyCodeLine{00061\ \textcolor{comment}{//}}
\DoxyCodeLine{00062\ \textcolor{comment}{//\ Examples\ with\ bit-\/width\ 1\ (eg\ encoding\ booleans):}}
\DoxyCodeLine{00063\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00064\ \textcolor{comment}{//\ 100\ 1s\ followed\ by\ 100\ 0s:}}
\DoxyCodeLine{00065\ \textcolor{comment}{//\ <varint(100\ <<\ 1)>\ <1,\ padded\ to\ 1\ byte>\ <varint(100\ <<\ 1)>\ <0,\ padded\ to\ 1\ byte>}}
\DoxyCodeLine{00066\ \textcolor{comment}{//\ \ -\/\ (total\ 4\ bytes)}}
\DoxyCodeLine{00067\ \textcolor{comment}{//}}
\DoxyCodeLine{00068\ \textcolor{comment}{//\ alternating\ 1s\ and\ 0s\ (200\ total):}}
\DoxyCodeLine{00069\ \textcolor{comment}{//\ 200\ ints\ =\ 25\ groups\ of\ 8}}
\DoxyCodeLine{00070\ \textcolor{comment}{//\ <varint((25\ <<\ 1)\ |\ 1)>\ <25\ bytes\ of\ values,\ bitpacked>}}
\DoxyCodeLine{00071\ \textcolor{comment}{//\ (total\ 26\ bytes,\ 1\ byte\ overhead)}}
\DoxyCodeLine{00072\ \textcolor{comment}{//}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \textcolor{comment}{//\ Decoder\ class\ for\ RLE\ encoded\ data.}}
\DoxyCodeLine{00075\ \textcolor{comment}{//}}
\DoxyCodeLine{00076\ \textcolor{comment}{//\ NOTE:\ the\ encoded\ format\ does\ not\ have\ any\ length\ prefix\ or\ any\ other\ way\ of}}
\DoxyCodeLine{00077\ \textcolor{comment}{//\ indicating\ that\ the\ encoded\ sequence\ ends\ at\ a\ certain\ point,\ so\ the\ Decoder}}
\DoxyCodeLine{00078\ \textcolor{comment}{//\ methods\ may\ return\ some\ extra\ bits\ at\ the\ end\ before\ the\ read\ methods\ start}}
\DoxyCodeLine{00079\ \textcolor{comment}{//\ to\ return\ 0/false.}}
\DoxyCodeLine{00080\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00081\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_rle_decoder}{RleDecoder}}\ \{}
\DoxyCodeLine{00082\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ decoder\ object.\ buffer/buffer\_len\ is\ the\ decoded\ data.}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ bit\_width\ is\ the\ width\ of\ each\ value\ (before\ encoding).}}
\DoxyCodeLine{00085\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a4c019fa745c3dcc652d6bff9c5a58d98}{RleDecoder}}(\textcolor{keyword}{const}\ uint8\_t*\ buffer,\ \textcolor{keywordtype}{int}\ buffer\_len,\ \textcolor{keywordtype}{int}\ bit\_width)}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a3512ed61a9e3dafddeae49b89c195897}{bit\_reader\_}}(buffer,\ buffer\_len),}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_afe6221c200a0edcd3a03113e5aa559be}{bit\_width\_}}(bit\_width),}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a8e670314091ec9e7bd9996259f038d34}{current\_value\_}}(0),}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a64833aa6c626b99481febccc72fe0af5}{repeat\_count\_}}(0),}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_acc0f1eb70509c65ea8e42f9fb627a3c4}{literal\_count\_}}(0),}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ad006bc02aab3ee6ecd9231122232d27c}{rewind\_state\_}}(\mbox{\hyperlink{classdoris_1_1_rle_decoder_a2da4417c475cdb0e646c41e5a65a6794aeb31f47b133df8d649ad6d0b0c8139ec}{CANT\_REWIND}})\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ DCHECK\_GE(\mbox{\hyperlink{classdoris_1_1_rle_decoder_afe6221c200a0edcd3a03113e5aa559be}{bit\_width\_}},\ 1);}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ DCHECK\_LE(\mbox{\hyperlink{classdoris_1_1_rle_decoder_afe6221c200a0edcd3a03113e5aa559be}{bit\_width\_}},\ 64);}
\DoxyCodeLine{00094\ \ \ \ \ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a6e59737e1a488f7ba32aa7d7ad15dd1e}{RleDecoder}}()\ \{\}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{comment}{//\ Skip\ n\ values,\ and\ returns\ the\ number\ of\ non-\/zero\ entries\ skipped.}}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a427c6375e6f11cdc692f52e4a9efc93a}{Skip}}(\textcolor{keywordtype}{size\_t}\ to\_skip);}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{comment}{//\ Gets\ the\ next\ value.\ \ Returns\ false\ if\ there\ are\ no\ more.}}
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ad98b9aca5c29821f4c0c0157e91fab94}{Get}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ val);}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{comment}{//\ Seek\ to\ the\ previous\ value.}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a786c95da6929c567349004428bb10721}{RewindOne}}();}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{comment}{//\ Gets\ the\ next\ run\ of\ the\ same\ 'val'.\ Returns\ 0\ if\ there\ is\ no}}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{comment}{//\ more\ data\ to\ be\ decoded.\ Will\ return\ a\ run\ of\ at\ most\ 'max\_run'}}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{comment}{//\ values.\ If\ there\ are\ more\ values\ than\ this,\ the\ next\ call\ to}}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{comment}{//\ GetNextRun\ will\ return\ more\ from\ the\ same\ run.}}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a63c107adb742924c562f88bbf8efd7fa}{GetNextRun}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ val,\ \textcolor{keywordtype}{size\_t}\ max\_run);}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a683fae2558fb9e213feaa9c910feab3c}{get\_values}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values,\ \textcolor{keywordtype}{size\_t}\ num\_values);}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{comment}{//\ Get\ the\ count\ of\ current\ repeated\ value}}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a8f572b61540521079747e618a4ef4817}{repeated\_count}}();}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{comment}{//\ Get\ current\ repeated\ value,\ make\ sure\ that\ count\ equals\ repeated\_count()}}
\DoxyCodeLine{00119\ \ \ \ \ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ab7c0c7c06c9dac7b0d5e4179a9b838a4}{get\_repeated\_value}}(\textcolor{keywordtype}{size\_t}\ count);}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ad4609edc2b71e1821b08d407646dbe88}{ReadHeader}}();}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keyword}{enum}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a2da4417c475cdb0e646c41e5a65a6794}{RewindState}}\ \{\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a2da4417c475cdb0e646c41e5a65a6794a63f8ab2e9216b3e6cf154a9550a8f024}{REWIND\_LITERAL}},\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a2da4417c475cdb0e646c41e5a65a6794a0bd0e225876b4e0b35e9d34864dfec3a}{REWIND\_RUN}},\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a2da4417c475cdb0e646c41e5a65a6794aeb31f47b133df8d649ad6d0b0c8139ec}{CANT\_REWIND}}\ \};}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_bit_reader}{BitReader}}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a3512ed61a9e3dafddeae49b89c195897}{bit\_reader\_}};}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_afe6221c200a0edcd3a03113e5aa559be}{bit\_width\_}};}
\DoxyCodeLine{00128\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a8e670314091ec9e7bd9996259f038d34}{current\_value\_}};}
\DoxyCodeLine{00129\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a64833aa6c626b99481febccc72fe0af5}{repeat\_count\_}};}
\DoxyCodeLine{00130\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_acc0f1eb70509c65ea8e42f9fb627a3c4}{literal\_count\_}};}
\DoxyCodeLine{00131\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a2da4417c475cdb0e646c41e5a65a6794}{RewindState}}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ad006bc02aab3ee6ecd9231122232d27c}{rewind\_state\_}};}
\DoxyCodeLine{00132\ \};}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \textcolor{comment}{//\ Class\ to\ incrementally\ build\ the\ rle\ data.}}
\DoxyCodeLine{00135\ \textcolor{comment}{//\ The\ encoding\ has\ two\ modes:\ encoding\ repeated\ runs\ and\ literal\ runs.}}
\DoxyCodeLine{00136\ \textcolor{comment}{//\ If\ the\ run\ is\ sufficiently\ short,\ it\ is\ more\ efficient\ to\ encode\ as\ a\ literal\ run.}}
\DoxyCodeLine{00137\ \textcolor{comment}{//\ This\ class\ does\ so\ by\ buffering\ 8\ values\ at\ a\ time.\ \ If\ they\ are\ not\ all\ the\ same}}
\DoxyCodeLine{00138\ \textcolor{comment}{//\ they\ are\ added\ to\ the\ literal\ run.\ \ If\ they\ are\ the\ same,\ they\ are\ added\ to\ the}}
\DoxyCodeLine{00139\ \textcolor{comment}{//\ repeated\ run.\ \ When\ we\ switch\ modes,\ the\ previous\ run\ is\ flushed\ out.}}
\DoxyCodeLine{00140\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00141\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_rle_encoder}{RleEncoder}}\ \{}
\DoxyCodeLine{00142\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{comment}{//\ buffer:\ buffer\ to\ write\ bits\ to.}}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ bit\_width:\ max\ number\ of\ bits\ for\ value.}}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{comment}{//\ TODO:\ consider\ adding\ a\ min\_repeated\_run\_length\ so\ the\ caller\ can\ control}}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{//\ when\ values\ should\ be\ encoded\ as\ repeated\ runs.\ \ Currently\ this\ is\ derived}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{comment}{//\ based\ on\ the\ bit\_width,\ which\ can\ determine\ a\ storage\ optimal\ choice.}}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a7018c8fac4fb03f7c06c010adda9dc87}{RleEncoder}}(\mbox{\hyperlink{classdoris_1_1faststring}{faststring}}*\ buffer,\ \textcolor{keywordtype}{int}\ bit\_width)}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a65732e09c048e57215ca409f64ded417}{bit\_width\_}}(bit\_width),\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a250f96c60d36a74a025aa68db448f648}{bit\_writer\_}}(buffer)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ DCHECK\_GE(\mbox{\hyperlink{classdoris_1_1_rle_encoder_a65732e09c048e57215ca409f64ded417}{bit\_width\_}},\ 1);}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ DCHECK\_LE(\mbox{\hyperlink{classdoris_1_1_rle_encoder_a65732e09c048e57215ca409f64ded417}{bit\_width\_}},\ 64);}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_encoder_aa71d36872f416feaa853788a7a7a7ef8}{Clear}}();}
\DoxyCodeLine{00153\ \ \ \ \ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{comment}{//\ Reserve\ 'num\_bytes'\ bytes\ for\ a\ plain\ encoded\ header,\ set\ each}}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{comment}{//\ byte\ with\ 'val':\ this\ is\ used\ for\ the\ RLE-\/encoded\ data\ blocks\ in}}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{comment}{//\ order\ to\ be\ able\ to\ able\ to\ store\ the\ initial\ ordinal\ position}}
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{comment}{//\ and\ number\ of\ elements.\ This\ is\ a\ part\ of\ RleEncoder\ in\ order\ to}}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ maintain\ the\ correct\ offset\ in\ 'buffer'.}}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_aed9d46fc2031a372e68818447da1dbbb}{Reserve}}(\textcolor{keywordtype}{int}\ num\_bytes,\ uint8\_t\ val);}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ Encode\ value.\ This\ value\ must\ be\ representable\ with\ bit\_width\_\ bits.}}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a28234e7dece2f6fff3a3665477d07605}{Put}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}},\ \textcolor{keywordtype}{size\_t}\ run\_length\ =\ 1);}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ Flushes\ any\ pending\ values\ to\ the\ underlying\ buffer.}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ Returns\ the\ total\ number\ of\ bytes\ written}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a0cdef30913ef138483d59f4229e93e68}{Flush}}();}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{comment}{//\ Resets\ all\ the\ state\ in\ the\ encoder.}}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_aa71d36872f416feaa853788a7a7a7ef8}{Clear}}();}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a83673f215ab5ea7aee5c0c710c96c23e}{len}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a250f96c60d36a74a025aa68db448f648}{bit\_writer\_}}.\mbox{\hyperlink{classdoris_1_1_bit_writer_a6ae2fccc9813f5a23fa87c595c0f7bbe}{bytes\_written}}();\ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{comment}{//\ Flushes\ any\ buffered\ values.\ \ If\ this\ is\ part\ of\ a\ repeated\ run,\ this\ is\ largely}}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{comment}{//\ a\ no-\/op.}}
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{comment}{//\ If\ it\ is\ part\ of\ a\ literal\ run,\ this\ will\ call\ FlushLiteralRun,\ which\ writes}}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{comment}{//\ out\ the\ buffered\ literal\ values.}}
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{comment}{//\ If\ 'done'\ is\ true,\ the\ current\ run\ would\ be\ written\ even\ if\ it\ would\ normally}}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{comment}{//\ have\ been\ buffered\ more.\ \ This\ should\ only\ be\ called\ at\ the\ end,\ when\ the}}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{comment}{//\ encoder\ has\ received\ all\ values\ even\ if\ it\ would\ normally\ continue\ to\ be}}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{comment}{//\ buffered.}}
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a3b056ce0c7664232065d7e9a0903fffd}{FlushBufferedValues}}(\textcolor{keywordtype}{bool}\ done);}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{comment}{//\ Flushes\ literal\ values\ to\ the\ underlying\ buffer.\ \ If\ update\_indicator\_byte,}}
\DoxyCodeLine{00186\ \ \ \ \ \textcolor{comment}{//\ then\ the\ current\ literal\ run\ is\ complete\ and\ the\ indicator\ byte\ is\ updated.}}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a6af0d282468c0d4716317a6d630eaebb}{FlushLiteralRun}}(\textcolor{keywordtype}{bool}\ update\_indicator\_byte);}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{comment}{//\ Flushes\ a\ repeated\ run\ to\ the\ underlying\ buffer.}}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_af2f06e66de6329dd8ed8b8f35cf52e77}{FlushRepeatedRun}}();}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ bits\ needed\ to\ encode\ the\ value.}}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a65732e09c048e57215ca409f64ded417}{bit\_width\_}};}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{comment}{//\ Underlying\ buffer.}}
\DoxyCodeLine{00196\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_bit_writer}{BitWriter}}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a250f96c60d36a74a025aa68db448f648}{bit\_writer\_}};}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ buffer\ at\ most\ 8\ values\ for\ literals.\ \ This\ happens\ when\ the}}
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{comment}{//\ bit\_width\ is\ 1\ (so\ 8\ values\ fit\ in\ one\ byte).}}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{comment}{//\ TODO:\ generalize\ this\ to\ other\ bit\ widths}}
\DoxyCodeLine{00201\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a15a9e3082f74a1178bdc5187003a219d}{buffered\_values\_}}[8];}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ values\ in\ buffered\_values\_}}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_aaa0a459f8dbb22144bab0a221a993b73}{num\_buffered\_values\_}};}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{comment}{//\ The\ current\ (also\ last)\ value\ that\ was\ written\ and\ the\ count\ of\ how}}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{comment}{//\ many\ times\ in\ a\ row\ that\ value\ has\ been\ seen.\ \ This\ is\ maintained\ even}}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{comment}{//\ if\ we\ are\ in\ a\ literal\ run.\ \ If\ the\ repeat\_count\_\ get\ high\ enough,\ we\ switch}}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{comment}{//\ to\ encoding\ repeated\ runs.}}
\DoxyCodeLine{00210\ \ \ \ \ uint64\_t\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a8e670314091ec9e7bd9996259f038d34}{current\_value\_}};}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a8395ada4b4db2a571df32eaca96ca566}{repeat\_count\_}};}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ literals\ in\ the\ current\ run.\ \ This\ does\ not\ include\ the\ literals}}
\DoxyCodeLine{00214\ \ \ \ \ \textcolor{comment}{//\ that\ might\ be\ in\ buffered\_values\_.\ \ Only\ after\ we've\ got\ a\ group\ big\ enough}}
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{comment}{//\ can\ we\ decide\ if\ they\ should\ part\ of\ the\ literal\_count\_\ or\ repeat\_count\_}}
\DoxyCodeLine{00216\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_afedfe7f9f229c574d071761b7ce956ec}{literal\_count\_}};}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{comment}{//\ Index\ of\ a\ byte\ in\ the\ underlying\ buffer\ that\ stores\ the\ indicator\ byte.}}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{comment}{//\ This\ is\ reserved\ as\ soon\ as\ we\ need\ a\ literal\ run\ but\ the\ value\ is\ written}}
\DoxyCodeLine{00220\ \ \ \ \ \textcolor{comment}{//\ when\ the\ literal\ run\ is\ complete.\ We\ maintain\ an\ index\ rather\ than\ a\ pointer}}
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{comment}{//\ into\ the\ underlying\ buffer\ because\ the\ pointer\ value\ may\ become\ invalid\ if}}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{comment}{//\ the\ underlying\ buffer\ is\ resized.}}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a1b138ca9d0a7e283ebaafcb65df5697b}{literal\_indicator\_byte\_idx\_}};}
\DoxyCodeLine{00224\ \};}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00227\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ad4609edc2b71e1821b08d407646dbe88}{RleDecoder<T>::ReadHeader}}()\ \{}
\DoxyCodeLine{00228\ \ \ \ \ DCHECK(bit\_reader\_.is\_initialized());}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_aff70f3c8f03aae06b9011058a8da0cf0}{PREDICT\_FALSE}}(literal\_count\_\ ==\ 0\ \&\&\ repeat\_count\_\ ==\ 0))\ \{}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Read\ the\ next\ run's\ indicator\ int,\ it\ could\ be\ a\ literal\ or\ repeated\ run}}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ int\ is\ encoded\ as\ a\ vlq-\/encoded\ value.}}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ uint32\_t\ indicator\_value\ =\ 0;}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetVlqInt(\&indicator\_value);}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_aff70f3c8f03aae06b9011058a8da0cf0}{PREDICT\_FALSE}}(!result))\ \{}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lsb\ indicates\ if\ it\ is\ a\ literal\ run\ or\ repeated\ run}}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{glob_8c_a9fe0e9477958d30ae57464929ca22f34}{is\_literal}}\ =\ indicator\_value\ \&\ 1;}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{glob_8c_a9fe0e9477958d30ae57464929ca22f34}{is\_literal}})\ \{}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ literal\_count\_\ =\ (indicator\_value\ >>\ 1)\ *\ 8;}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_GT(literal\_count\_,\ 0);}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ =\ indicator\_value\ >>\ 1;}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_GT(repeat\_count\_,\ 0);}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetAligned<\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}>(\mbox{\hyperlink{classdoris_1_1_bit_util_ab9002e6aac9b818996faf615f08e426a}{BitUtil::Ceil}}(bit\_width\_,\ 8),}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{reinterpret\_cast<}\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\textcolor{keyword}{>}(\&current\_value\_));}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(result);}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00250\ \ \ \ \ \}}
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00252\ \}}
\DoxyCodeLine{00253\ }
\DoxyCodeLine{00254\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00255\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ad98b9aca5c29821f4c0c0157e91fab94}{RleDecoder<T>::Get}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ val)\ \{}
\DoxyCodeLine{00256\ \ \ \ \ DCHECK(bit\_reader\_.is\_initialized());}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_aff70f3c8f03aae06b9011058a8da0cf0}{PREDICT\_FALSE}}(!ReadHeader()))\ \{}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00259\ \ \ \ \ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_a9e276e58cb5539281d80bf7676bd73a7}{PREDICT\_TRUE}}(repeat\_count\_\ >\ 0))\ \{}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ *val\ =\ current\_value\_;}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ -\/-\/repeat\_count\_;}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ rewind\_state\_\ =\ REWIND\_RUN;}
\DoxyCodeLine{00265\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ DCHECK(literal\_count\_\ >\ 0);}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetValue(bit\_width\_,\ val);}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ DCHECK(result);}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ -\/-\/literal\_count\_;}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ rewind\_state\_\ =\ REWIND\_LITERAL;}
\DoxyCodeLine{00271\ \ \ \ \ \}}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00274\ \}}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00277\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a786c95da6929c567349004428bb10721}{RleDecoder<T>::RewindOne}}()\ \{}
\DoxyCodeLine{00278\ \ \ \ \ DCHECK(bit\_reader\_.is\_initialized());}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{keywordflow}{switch}\ (rewind\_state\_)\ \{}
\DoxyCodeLine{00281\ \ \ \ \ \textcolor{keywordflow}{case}\ CANT\_REWIND:}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ LOG(FATAL)\ <<\ \textcolor{stringliteral}{"{}Can't\ rewind\ more\ than\ once\ after\ each\ read!"{}};}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{case}\ REWIND\_RUN:}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ ++repeat\_count\_;}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00287\ \ \ \ \ \textcolor{keywordflow}{case}\ REWIND\_LITERAL:\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ bit\_reader\_.Rewind(bit\_width\_);}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ ++literal\_count\_;}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00291\ \ \ \ \ \}}
\DoxyCodeLine{00292\ \ \ \ \ \}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ \ \ rewind\_state\_\ =\ CANT\_REWIND;}
\DoxyCodeLine{00295\ \}}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00298\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a63c107adb742924c562f88bbf8efd7fa}{RleDecoder<T>::GetNextRun}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ val,\ \textcolor{keywordtype}{size\_t}\ max\_run)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ DCHECK(bit\_reader\_.is\_initialized());}
\DoxyCodeLine{00300\ \ \ \ \ DCHECK\_GT(max\_run,\ 0);}
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}\ =\ 0;}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ rem\ =\ max\_run;}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keywordflow}{while}\ (ReadHeader())\ \{}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_a9e276e58cb5539281d80bf7676bd73a7}{PREDICT\_TRUE}}(repeat\_count\_\ >\ 0))\ \{}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_aff70f3c8f03aae06b9011058a8da0cf0}{PREDICT\_FALSE}}(\mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}\ >\ 0\ \&\&\ *val\ !=\ current\_value\_))\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}};}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ *val\ =\ current\_value\_;}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >=\ rem)\ \{}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ next\ run\ is\ longer\ than\ the\ amount\ of\ remaining\ data}}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ that\ the\ caller\ wants\ to\ read.\ Only\ consume\ it\ partially.}}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ -\/=\ rem;}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}\ +=\ rem;}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}};}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}\ +=\ repeat\_count\_;}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ rem\ -\/=\ repeat\_count\_;}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ =\ 0;}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(literal\_count\_\ >\ 0);}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}\ ==\ 0)\ \{}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ has\_more\ =\ bit\_reader\_.GetValue(bit\_width\_,\ val);}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(has\_more);}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ literal\_count\_-\/-\/;}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}++;}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rem-\/-\/;}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (literal\_count\_\ >\ 0)\ \{}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetValue(bit\_width\_,\ \&current\_value\_);}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(result);}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_value\_\ !=\ *val\ ||\ rem\ ==\ 0)\ \{}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ bit\_reader\_.Rewind(bit\_width\_);}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}};}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}++;}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rem-\/-\/;}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ literal\_count\_-\/-\/;}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00341\ \ \ \ \ \}}
\DoxyCodeLine{00342\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}};}
\DoxyCodeLine{00343\ \}}
\DoxyCodeLine{00344\ }
\DoxyCodeLine{00345\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00346\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a683fae2558fb9e213feaa9c910feab3c}{RleDecoder<T>::get\_values}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values,\ \textcolor{keywordtype}{size\_t}\ num\_values)\ \{}
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ read\_num\ =\ 0;}
\DoxyCodeLine{00348\ \ \ \ \ \textcolor{keywordflow}{while}\ (read\_num\ <\ num\_values)\ \{}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ read\_this\_time\ =\ num\_values\ -\/\ read\_num;}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a262afcfe437f4addb13fb1b47a6a7086}{LIKELY}}(repeat\_count\_\ >\ 0))\ \{}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ \ \ \ \ read\_this\_time\ =\ std::min((\textcolor{keywordtype}{size\_t})repeat\_count\_,\ read\_this\_time);}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ \ \ std::fill(values,\ values\ +\ read\_this\_time,\ current\_value\_);}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ values\ +=\ read\_this\_time;}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ -\/=\ read\_this\_time;}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \ \ \ \ read\_num\ +=\ read\_this\_time;}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (literal\_count\_\ >\ 0)\ \{}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ \ \ \ \ read\_this\_time\ =\ std::min((\textcolor{keywordtype}{size\_t})literal\_count\_,\ read\_this\_time);}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ read\_this\_time;\ ++i)\ \{}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetValue(bit\_width\_,\ values);}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(result);}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ values++;}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \ \ \ \ \ \ literal\_count\_\ -\/=\ read\_this\_time;}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \ \ \ \ \ \ read\_num\ +=\ read\_this\_time;}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!ReadHeader())\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ read\_num;}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00371\ \ \ \ \ \}}
\DoxyCodeLine{00372\ \ \ \ \ \textcolor{keywordflow}{return}\ read\_num;}
\DoxyCodeLine{00373\ \}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00376\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a8f572b61540521079747e618a4ef4817}{RleDecoder<T>::repeated\_count}}()\ \{}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >\ 0)\ \{}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ repeat\_count\_;}
\DoxyCodeLine{00379\ \ \ \ \ \}}
\DoxyCodeLine{00380\ \ \ \ \ \textcolor{keywordflow}{if}\ (literal\_count\_\ ==\ 0)\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \ \ ReadHeader();}
\DoxyCodeLine{00382\ \ \ \ \ \}}
\DoxyCodeLine{00383\ \ \ \ \ \textcolor{keywordflow}{return}\ repeat\_count\_;}
\DoxyCodeLine{00384\ \}}
\DoxyCodeLine{00385\ }
\DoxyCodeLine{00386\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00387\ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_ab7c0c7c06c9dac7b0d5e4179a9b838a4}{RleDecoder<T>::get\_repeated\_value}}(\textcolor{keywordtype}{size\_t}\ count)\ \{}
\DoxyCodeLine{00388\ \ \ \ \ DCHECK\_GE(repeat\_count\_,\ count);}
\DoxyCodeLine{00389\ \ \ \ \ repeat\_count\_\ -\/=\ count;}
\DoxyCodeLine{00390\ \ \ \ \ \textcolor{keywordflow}{return}\ current\_value\_;}
\DoxyCodeLine{00391\ \}}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00394\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1_rle_decoder_a427c6375e6f11cdc692f52e4a9efc93a}{RleDecoder<T>::Skip}}(\textcolor{keywordtype}{size\_t}\ to\_skip)\ \{}
\DoxyCodeLine{00395\ \ \ \ \ DCHECK(bit\_reader\_.is\_initialized());}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ set\_count\ =\ 0;}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{keywordflow}{while}\ (to\_skip\ >\ 0)\ \{}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ ReadHeader();}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \ \ DCHECK(result);}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_a9e276e58cb5539281d80bf7676bd73a7}{PREDICT\_TRUE}}(repeat\_count\_\ >\ 0))\ \{}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ nskip\ =\ (repeat\_count\_\ <\ to\_skip)\ ?\ repeat\_count\_\ :\ to\_skip;}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ -\/=\ nskip;}
\DoxyCodeLine{00405\ \ \ \ \ \ \ \ \ \ \ \ \ to\_skip\ -\/=\ nskip;}
\DoxyCodeLine{00406\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_value\_\ !=\ 0)\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ set\_count\ +=\ nskip;}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(literal\_count\_\ >\ 0);}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ nskip\ =\ (literal\_count\_\ <\ to\_skip)\ ?\ literal\_count\_\ :\ to\_skip;}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \ \ \ \ \ \ literal\_count\_\ -\/=\ nskip;}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \ \ \ \ \ \ to\_skip\ -\/=\ nskip;}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ nskip\ >\ 0;\ nskip-\/-\/)\ \{}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}}\ =\ 0;}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetValue(bit\_width\_,\ \&\mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}});}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK(result);}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}}\ !=\ 0)\ \{}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ set\_count++;}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00423\ \ \ \ \ \}}
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{keywordflow}{return}\ set\_count;}
\DoxyCodeLine{00425\ \}}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00427\ \textcolor{comment}{//\ This\ function\ buffers\ input\ values\ 8\ at\ a\ time.\ \ After\ seeing\ all\ 8\ values,}}
\DoxyCodeLine{00428\ \textcolor{comment}{//\ it\ decides\ whether\ they\ should\ be\ encoded\ as\ a\ literal\ or\ repeated\ run.}}
\DoxyCodeLine{00429\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00430\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a28234e7dece2f6fff3a3665477d07605}{RleEncoder<T>::Put}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}},\ \textcolor{keywordtype}{size\_t}\ run\_length)\ \{}
\DoxyCodeLine{00431\ \ \ \ \ DCHECK(bit\_width\_\ ==\ 64\ ||\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}}\ <\ (1LL\ <<\ bit\_width\_));}
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{comment}{//\ TODO(perf):\ remove\ the\ loop\ and\ use\ the\ repeat\_count\_}}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ run\_length\ >\ 0;\ run\_length-\/-\/)\ \{}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{port_8h_a9e276e58cb5539281d80bf7676bd73a7}{PREDICT\_TRUE}}(current\_value\_\ ==\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}}))\ \{}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \ \ \ \ \ \ ++repeat\_count\_;}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >\ 8)\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ just\ a\ continuation\ of\ the\ current\ run,\ no\ need\ to\ buffer\ the}}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ values.}}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Note\ that\ this\ is\ the\ fast\ path\ for\ long\ repeated\ runs.}}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >=\ 8)\ \{}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ had\ a\ run\ that\ was\ long\ enough\ but\ it\ has\ ended.\ \ Flush\ the}}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ current\ repeated\ run.}}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_EQ(literal\_count\_,\ 0);}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FlushRepeatedRun();}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ =\ 1;}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ \ \ \ \ current\_value\_\ =\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}};}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00453\ }
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ buffered\_values\_[num\_buffered\_values\_]\ =\ \mbox{\hyperlink{util_2types_8h_adae7202c63102b0934c3ac5be41b0dae}{value}};}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (++num\_buffered\_values\_\ ==\ 8)\ \{}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_EQ(literal\_count\_\ \%\ 8,\ 0);}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ \ \ \ \ FlushBufferedValues(\textcolor{keyword}{false});}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00459\ \ \ \ \ \}}
\DoxyCodeLine{00460\ \}}
\DoxyCodeLine{00461\ }
\DoxyCodeLine{00462\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00463\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a6af0d282468c0d4716317a6d630eaebb}{RleEncoder<T>::FlushLiteralRun}}(\textcolor{keywordtype}{bool}\ update\_indicator\_byte)\ \{}
\DoxyCodeLine{00464\ \ \ \ \ \textcolor{keywordflow}{if}\ (literal\_indicator\_byte\_idx\_\ <\ 0)\ \{}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ literal\ indicator\ byte\ has\ not\ been\ reserved\ yet,\ get\ one\ now.}}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \ \ literal\_indicator\_byte\_idx\_\ =\ bit\_writer\_.GetByteIndexAndAdvance(1);}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ DCHECK\_GE(literal\_indicator\_byte\_idx\_,\ 0);}
\DoxyCodeLine{00468\ \ \ \ \ \}}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ \ \ \ \ \textcolor{comment}{//\ Write\ all\ the\ buffered\ values\ as\ bit\ packed\ literals}}
\DoxyCodeLine{00471\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_buffered\_values\_;\ ++i)\ \{}
\DoxyCodeLine{00472\ \ \ \ \ \ \ \ \ bit\_writer\_.PutValue(buffered\_values\_[i],\ bit\_width\_);}
\DoxyCodeLine{00473\ \ \ \ \ \}}
\DoxyCodeLine{00474\ \ \ \ \ num\_buffered\_values\_\ =\ 0;}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{keywordflow}{if}\ (update\_indicator\_byte)\ \{}
\DoxyCodeLine{00477\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ At\ this\ point\ we\ need\ to\ write\ the\ indicator\ byte\ for\ the\ literal\ run.}}
\DoxyCodeLine{00478\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ only\ reserve\ one\ byte,\ to\ allow\ for\ streaming\ writes\ of\ literal\ values.}}
\DoxyCodeLine{00479\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ logic\ makes\ sure\ we\ flush\ literal\ runs\ often\ enough\ to\ not\ overrun}}
\DoxyCodeLine{00480\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ 1\ byte.}}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_groups\ =\ \mbox{\hyperlink{classdoris_1_1_bit_util_ab9002e6aac9b818996faf615f08e426a}{BitUtil::Ceil}}(literal\_count\_,\ 8);}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ int32\_t\ indicator\_value\ =\ (num\_groups\ <<\ 1)\ |\ 1;}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ DCHECK\_EQ(indicator\_value\ \&\ 0xFFFFFF00,\ 0);}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \ \ bit\_writer\_.buffer()-\/>data()[literal\_indicator\_byte\_idx\_]\ =\ indicator\_value;}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ literal\_indicator\_byte\_idx\_\ =\ -\/1;}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ literal\_count\_\ =\ 0;}
\DoxyCodeLine{00487\ \ \ \ \ \}}
\DoxyCodeLine{00488\ \}}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00491\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_af2f06e66de6329dd8ed8b8f35cf52e77}{RleEncoder<T>::FlushRepeatedRun}}()\ \{}
\DoxyCodeLine{00492\ \ \ \ \ DCHECK\_GT(repeat\_count\_,\ 0);}
\DoxyCodeLine{00493\ \ \ \ \ \textcolor{comment}{//\ The\ lsb\ of\ 0\ indicates\ this\ is\ a\ repeated\ run}}
\DoxyCodeLine{00494\ \ \ \ \ int32\_t\ indicator\_value\ =\ repeat\_count\_\ <<\ 1\ |\ 0;}
\DoxyCodeLine{00495\ \ \ \ \ bit\_writer\_.PutVlqInt(indicator\_value);}
\DoxyCodeLine{00496\ \ \ \ \ bit\_writer\_.PutAligned(current\_value\_,\ \mbox{\hyperlink{classdoris_1_1_bit_util_ab9002e6aac9b818996faf615f08e426a}{BitUtil::Ceil}}(bit\_width\_,\ 8));}
\DoxyCodeLine{00497\ \ \ \ \ num\_buffered\_values\_\ =\ 0;}
\DoxyCodeLine{00498\ \ \ \ \ repeat\_count\_\ =\ 0;}
\DoxyCodeLine{00499\ \}}
\DoxyCodeLine{00500\ }
\DoxyCodeLine{00501\ \textcolor{comment}{//\ Flush\ the\ values\ that\ have\ been\ buffered.\ \ At\ this\ point\ we\ decide\ whether}}
\DoxyCodeLine{00502\ \textcolor{comment}{//\ we\ need\ to\ switch\ between\ the\ run\ types\ or\ continue\ the\ current\ one.}}
\DoxyCodeLine{00503\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00504\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a3b056ce0c7664232065d7e9a0903fffd}{RleEncoder<T>::FlushBufferedValues}}(\textcolor{keywordtype}{bool}\ done)\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >=\ 8)\ \{}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Clear\ the\ buffered\ values.\ \ They\ are\ part\ of\ the\ repeated\ run\ now\ and\ we}}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ don't\ want\ to\ flush\ them\ out\ as\ literals.}}
\DoxyCodeLine{00508\ \ \ \ \ \ \ \ \ num\_buffered\_values\_\ =\ 0;}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (literal\_count\_\ !=\ 0)\ \{}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ was\ a\ current\ literal\ run.\ \ All\ the\ values\ in\ it\ have\ been\ flushed}}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ but\ we\ still\ need\ to\ update\ the\ indicator\ byte.}}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_EQ(literal\_count\_\ \%\ 8,\ 0);}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_EQ(repeat\_count\_,\ 8);}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \ \ \ \ FlushLiteralRun(\textcolor{keyword}{true});}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ DCHECK\_EQ(literal\_count\_,\ 0);}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00518\ \ \ \ \ \}}
\DoxyCodeLine{00519\ }
\DoxyCodeLine{00520\ \ \ \ \ literal\_count\_\ +=\ num\_buffered\_values\_;}
\DoxyCodeLine{00521\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_groups\ =\ \mbox{\hyperlink{classdoris_1_1_bit_util_ab9002e6aac9b818996faf615f08e426a}{BitUtil::Ceil}}(literal\_count\_,\ 8);}
\DoxyCodeLine{00522\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_groups\ +\ 1\ >=\ (1\ <<\ 6))\ \{}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ start\ a\ new\ literal\ run\ because\ the\ indicator\ byte\ we've\ reserved}}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cannot\ store\ more\ values.}}
\DoxyCodeLine{00525\ \ \ \ \ \ \ \ \ DCHECK\_GE(literal\_indicator\_byte\_idx\_,\ 0);}
\DoxyCodeLine{00526\ \ \ \ \ \ \ \ \ FlushLiteralRun(\textcolor{keyword}{true});}
\DoxyCodeLine{00527\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ FlushLiteralRun(done);}
\DoxyCodeLine{00529\ \ \ \ \ \}}
\DoxyCodeLine{00530\ \ \ \ \ repeat\_count\_\ =\ 0;}
\DoxyCodeLine{00531\ \}}
\DoxyCodeLine{00532\ }
\DoxyCodeLine{00533\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00534\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_aed9d46fc2031a372e68818447da1dbbb}{RleEncoder<T>::Reserve}}(\textcolor{keywordtype}{int}\ num\_bytes,\ uint8\_t\ val)\ \{}
\DoxyCodeLine{00535\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_bytes;\ ++i)\ \{}
\DoxyCodeLine{00536\ \ \ \ \ \ \ \ \ bit\_writer\_.PutValue(val,\ 8);}
\DoxyCodeLine{00537\ \ \ \ \ \}}
\DoxyCodeLine{00538\ \}}
\DoxyCodeLine{00539\ }
\DoxyCodeLine{00540\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00541\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_a0cdef30913ef138483d59f4229e93e68}{RleEncoder<T>::Flush}}()\ \{}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{keywordflow}{if}\ (literal\_count\_\ >\ 0\ ||\ repeat\_count\_\ >\ 0\ ||\ num\_buffered\_values\_\ >\ 0)\ \{}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ all\_repeat\ =\ literal\_count\_\ ==\ 0\ \&\&}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (repeat\_count\_\ ==\ num\_buffered\_values\_\ ||\ num\_buffered\_values\_\ ==\ 0);}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ is\ something\ pending,\ figure\ out\ if\ it's\ a\ repeated\ or\ literal\ run}}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >\ 0\ \&\&\ all\_repeat)\ \{}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \ \ \ \ \ \ FlushRepeatedRun();}
\DoxyCodeLine{00548\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \ \ \ \ literal\_count\_\ +=\ num\_buffered\_values\_;}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ \ \ \ \ FlushLiteralRun(\textcolor{keyword}{true});}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \ \ \ \ \ \ repeat\_count\_\ =\ 0;}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00553\ \ \ \ \ \}}
\DoxyCodeLine{00554\ \ \ \ \ bit\_writer\_.Flush();}
\DoxyCodeLine{00555\ \ \ \ \ DCHECK\_EQ(num\_buffered\_values\_,\ 0);}
\DoxyCodeLine{00556\ \ \ \ \ DCHECK\_EQ(literal\_count\_,\ 0);}
\DoxyCodeLine{00557\ \ \ \ \ DCHECK\_EQ(repeat\_count\_,\ 0);}
\DoxyCodeLine{00558\ \ \ \ \ \textcolor{keywordflow}{return}\ bit\_writer\_.bytes\_written();}
\DoxyCodeLine{00559\ \}}
\DoxyCodeLine{00560\ }
\DoxyCodeLine{00561\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00562\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_encoder_aa71d36872f416feaa853788a7a7a7ef8}{RleEncoder<T>::Clear}}()\ \{}
\DoxyCodeLine{00563\ \ \ \ \ current\_value\_\ =\ 0;}
\DoxyCodeLine{00564\ \ \ \ \ repeat\_count\_\ =\ 0;}
\DoxyCodeLine{00565\ \ \ \ \ num\_buffered\_values\_\ =\ 0;}
\DoxyCodeLine{00566\ \ \ \ \ literal\_count\_\ =\ 0;}
\DoxyCodeLine{00567\ \ \ \ \ literal\_indicator\_byte\_idx\_\ =\ -\/1;}
\DoxyCodeLine{00568\ \ \ \ \ bit\_writer\_.Clear();}
\DoxyCodeLine{00569\ \}}
\DoxyCodeLine{00570\ }
\DoxyCodeLine{00571\ \textcolor{comment}{//\ Copy\ from\ https://github.com/apache/impala/blob/master/be/src/util/rle-\/encoding.h}}
\DoxyCodeLine{00572\ \textcolor{comment}{//\ Utility\ classes\ to\ do\ run\ length\ encoding\ (RLE)\ for\ fixed\ bit\ width\ values.\ \ If\ runs}}
\DoxyCodeLine{00573\ \textcolor{comment}{//\ are\ sufficiently\ long,\ RLE\ is\ used,\ otherwise,\ the\ values\ are\ just\ bit-\/packed}}
\DoxyCodeLine{00574\ \textcolor{comment}{//\ (literal\ encoding).}}
\DoxyCodeLine{00575\ \textcolor{comment}{//}}
\DoxyCodeLine{00576\ \textcolor{comment}{//\ For\ both\ types\ of\ runs,\ there\ is\ a\ byte-\/aligned\ indicator\ which\ encodes\ the\ length}}
\DoxyCodeLine{00577\ \textcolor{comment}{//\ of\ the\ run\ and\ the\ type\ of\ the\ run.}}
\DoxyCodeLine{00578\ \textcolor{comment}{//}}
\DoxyCodeLine{00579\ \textcolor{comment}{//\ This\ encoding\ has\ the\ benefit\ that\ when\ there\ aren't\ any\ long\ enough\ runs,\ values}}
\DoxyCodeLine{00580\ \textcolor{comment}{//\ are\ always\ decoded\ at\ fixed\ (can\ be\ precomputed)\ bit\ offsets\ OR\ both\ the\ value\ and}}
\DoxyCodeLine{00581\ \textcolor{comment}{//\ the\ run\ length\ are\ byte\ aligned.\ This\ allows\ for\ very\ efficient\ decoding}}
\DoxyCodeLine{00582\ \textcolor{comment}{//\ implementations.}}
\DoxyCodeLine{00583\ \textcolor{comment}{//\ The\ encoding\ is:}}
\DoxyCodeLine{00584\ \textcolor{comment}{//\ \ \ \ encoded-\/block\ :=\ run*}}
\DoxyCodeLine{00585\ \textcolor{comment}{//\ \ \ \ run\ :=\ literal-\/run\ |\ repeated-\/run}}
\DoxyCodeLine{00586\ \textcolor{comment}{//\ \ \ \ literal-\/run\ :=\ literal-\/indicator\ <\ literal\ bytes\ >}}
\DoxyCodeLine{00587\ \textcolor{comment}{//\ \ \ \ repeated-\/run\ :=\ repeated-\/indicator\ <\ repeated\ value.\ padded\ to\ byte\ boundary\ >}}
\DoxyCodeLine{00588\ \textcolor{comment}{//\ \ \ \ literal-\/indicator\ :=\ varint\_encode(\ number\_of\_groups\ <<\ 1\ |\ 1)}}
\DoxyCodeLine{00589\ \textcolor{comment}{//\ \ \ \ repeated-\/indicator\ :=\ varint\_encode(\ number\_of\_repetitions\ <<\ 1\ )}}
\DoxyCodeLine{00590\ \textcolor{comment}{//}}
\DoxyCodeLine{00591\ \textcolor{comment}{//\ Each\ run\ is\ preceded\ by\ a\ varint.\ The\ varint's\ least\ significant\ bit\ is}}
\DoxyCodeLine{00592\ \textcolor{comment}{//\ used\ to\ indicate\ whether\ the\ run\ is\ a\ literal\ run\ or\ a\ repeated\ run.\ The\ rest}}
\DoxyCodeLine{00593\ \textcolor{comment}{//\ of\ the\ varint\ is\ used\ to\ determine\ the\ length\ of\ the\ run\ (eg\ how\ many\ times\ the}}
\DoxyCodeLine{00594\ \textcolor{comment}{//\ value\ repeats).}}
\DoxyCodeLine{00595\ \textcolor{comment}{//}}
\DoxyCodeLine{00596\ \textcolor{comment}{//\ In\ the\ case\ of\ literal\ runs,\ the\ run\ length\ is\ always\ a\ multiple\ of\ 8\ (i.e.\ encode}}
\DoxyCodeLine{00597\ \textcolor{comment}{//\ in\ groups\ of\ 8),\ so\ that\ no\ matter\ the\ bit-\/width\ of\ the\ value,\ the\ sequence\ will\ end}}
\DoxyCodeLine{00598\ \textcolor{comment}{//\ on\ a\ byte\ boundary\ without\ padding.}}
\DoxyCodeLine{00599\ \textcolor{comment}{//\ Given\ that\ we\ know\ it\ is\ a\ multiple\ of\ 8,\ we\ store\ the\ number\ of\ 8-\/groups\ rather\ than}}
\DoxyCodeLine{00600\ \textcolor{comment}{//\ the\ actual\ number\ of\ encoded\ ints.\ (This\ means\ that\ the\ total\ number\ of\ encoded\ values}}
\DoxyCodeLine{00601\ \textcolor{comment}{//\ can\ not\ be\ determined\ from\ the\ encoded\ data,\ since\ the\ number\ of\ values\ in\ the\ last}}
\DoxyCodeLine{00602\ \textcolor{comment}{//\ group\ may\ not\ be\ a\ multiple\ of\ 8).\ For\ the\ last\ group\ of\ literal\ runs,\ we\ pad}}
\DoxyCodeLine{00603\ \textcolor{comment}{//\ the\ group\ to\ 8\ with\ zeros.\ This\ allows\ for\ 8\ at\ a\ time\ decoding\ on\ the\ read\ side}}
\DoxyCodeLine{00604\ \textcolor{comment}{//\ without\ the\ need\ for\ additional\ checks.}}
\DoxyCodeLine{00605\ \textcolor{comment}{//}}
\DoxyCodeLine{00606\ \textcolor{comment}{//\ There\ is\ a\ break-\/even\ point\ when\ it\ is\ more\ storage\ efficient\ to\ do\ run\ length}}
\DoxyCodeLine{00607\ \textcolor{comment}{//\ encoding.\ \ For\ 1\ bit-\/width\ values,\ that\ point\ is\ 8\ values.\ \ They\ require\ 2\ bytes}}
\DoxyCodeLine{00608\ \textcolor{comment}{//\ for\ both\ the\ repeated\ encoding\ or\ the\ literal\ encoding.\ \ This\ value\ can\ always}}
\DoxyCodeLine{00609\ \textcolor{comment}{//\ be\ computed\ based\ on\ the\ bit-\/width.}}
\DoxyCodeLine{00610\ \textcolor{comment}{//\ TODO:\ For\ 1\ bit-\/width\ values\ it\ can\ be\ optimal\ to\ use\ 16\ or\ 24\ values,\ but\ more}}
\DoxyCodeLine{00611\ \textcolor{comment}{//\ investigation\ is\ needed\ to\ do\ this\ efficiently,\ see\ the\ reverted\ IMPALA-\/6658.}}
\DoxyCodeLine{00612\ \textcolor{comment}{//\ TODO:\ think\ about\ how\ to\ use\ this\ for\ strings.\ \ The\ bit\ packing\ isn't\ quite\ the\ same.}}
\DoxyCodeLine{00613\ \textcolor{comment}{//}}
\DoxyCodeLine{00614\ \textcolor{comment}{//\ Examples\ with\ bit-\/width\ 1\ (eg\ encoding\ booleans):}}
\DoxyCodeLine{00615\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00616\ \textcolor{comment}{//\ 100\ 1s\ followed\ by\ 100\ 0s:}}
\DoxyCodeLine{00617\ \textcolor{comment}{//\ <varint(100\ <<\ 1)>\ <1,\ padded\ to\ 1\ byte>\ <varint(100\ <<\ 1)>\ <0,\ padded\ to\ 1\ byte>}}
\DoxyCodeLine{00618\ \textcolor{comment}{//\ \ -\/\ (total\ 4\ bytes)}}
\DoxyCodeLine{00619\ \textcolor{comment}{//}}
\DoxyCodeLine{00620\ \textcolor{comment}{//\ alternating\ 1s\ and\ 0s\ (200\ total):}}
\DoxyCodeLine{00621\ \textcolor{comment}{//\ 200\ ints\ =\ 25\ groups\ of\ 8}}
\DoxyCodeLine{00622\ \textcolor{comment}{//\ <varint((25\ <<\ 1)\ |\ 1)>\ <25\ bytes\ of\ values,\ bitpacked>}}
\DoxyCodeLine{00623\ \textcolor{comment}{//\ (total\ 26\ bytes,\ 1\ byte\ overhead)}}
\DoxyCodeLine{00624\ }
\DoxyCodeLine{00625\ \textcolor{comment}{//\ RLE\ decoder\ with\ a\ batch-\/oriented\ interface\ that\ enables\ fast\ decoding.}}
\DoxyCodeLine{00626\ \textcolor{comment}{//\ Users\ of\ this\ class\ must\ first\ initialize\ the\ class\ to\ point\ to\ a\ buffer\ of}}
\DoxyCodeLine{00627\ \textcolor{comment}{//\ RLE-\/encoded\ data,\ passed\ into\ the\ constructor\ or\ Reset().\ The\ provided}}
\DoxyCodeLine{00628\ \textcolor{comment}{//\ bit\_width\ must\ be\ at\ most\ min(sizeof(T)\ *\ 8,\ BatchedBitReader::MAX\_BITWIDTH).}}
\DoxyCodeLine{00629\ \textcolor{comment}{//\ Then\ they\ can\ decode\ data\ by\ checking\ NextNumRepeats()/NextNumLiterals()\ to}}
\DoxyCodeLine{00630\ \textcolor{comment}{//\ see\ if\ the\ next\ run\ is\ a\ repeated\ or\ literal\ run,\ then\ calling}}
\DoxyCodeLine{00631\ \textcolor{comment}{//\ GetRepeatedValue()\ or\ GetLiteralValues()\ respectively\ to\ read\ the\ values.}}
\DoxyCodeLine{00632\ \textcolor{comment}{//}}
\DoxyCodeLine{00633\ \textcolor{comment}{//\ End-\/of-\/input\ is\ signalled\ by\ NextNumRepeats()\ ==\ NextNumLiterals()\ ==\ 0.}}
\DoxyCodeLine{00634\ \textcolor{comment}{//\ Other\ decoding\ errors\ are\ signalled\ by\ functions\ returning\ false.\ If\ an}}
\DoxyCodeLine{00635\ \textcolor{comment}{//\ error\ is\ encountered\ then\ it\ is\ not\ valid\ to\ read\ any\ more\ data\ until}}
\DoxyCodeLine{00636\ \textcolor{comment}{//\ Reset()\ is\ called.}}
\DoxyCodeLine{00637\ }
\DoxyCodeLine{00638\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00639\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_rle_batch_decoder}{RleBatchDecoder}}\ \{}
\DoxyCodeLine{00640\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00641\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a5f64458db7859d438d91be3e4ce3089e}{RleBatchDecoder}}(uint8\_t*\ buffer,\ \textcolor{keywordtype}{int}\ buffer\_len,\ \textcolor{keywordtype}{int}\ bit\_width)\ \{}
\DoxyCodeLine{00642\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a7566d4aac3ac6f2025253a31b4ad5c8d}{Reset}}(buffer,\ buffer\_len,\ bit\_width);}
\DoxyCodeLine{00643\ \ \ \ \ \}}
\DoxyCodeLine{00644\ }
\DoxyCodeLine{00645\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a57c7b2dfe9c56a4d3e2ef356c33267bf}{RleBatchDecoder}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00646\ }
\DoxyCodeLine{00647\ \ \ \ \ \textcolor{comment}{//\ Reset\ the\ decoder\ to\ read\ from\ a\ new\ buffer.}}
\DoxyCodeLine{00648\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a7566d4aac3ac6f2025253a31b4ad5c8d}{Reset}}(uint8\_t*\ buffer,\ \textcolor{keywordtype}{int}\ buffer\_len,\ \textcolor{keywordtype}{int}\ bit\_width);}
\DoxyCodeLine{00649\ }
\DoxyCodeLine{00650\ \ \ \ \ \textcolor{comment}{//\ Return\ the\ size\ of\ the\ current\ repeated\ run.\ Returns\ zero\ if\ the\ current\ run\ is}}
\DoxyCodeLine{00651\ \ \ \ \ \textcolor{comment}{//\ a\ literal\ run\ or\ if\ no\ more\ runs\ can\ be\ read\ from\ the\ input.}}
\DoxyCodeLine{00652\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_afbb581660ee9b6821d2a19a83b5f5062}{NextNumRepeats}}();}
\DoxyCodeLine{00653\ }
\DoxyCodeLine{00654\ \ \ \ \ \textcolor{comment}{//\ Get\ the\ value\ of\ the\ current\ repeated\ run\ and\ consume\ the\ given\ number\ of\ repeats.}}
\DoxyCodeLine{00655\ \ \ \ \ \textcolor{comment}{//\ Only\ valid\ to\ call\ when\ NextNumRepeats()\ >\ 0.\ The\ given\ number\ of\ repeats\ cannot}}
\DoxyCodeLine{00656\ \ \ \ \ \textcolor{comment}{//\ be\ greater\ than\ the\ remaining\ number\ of\ repeats\ in\ the\ run.\ 'num\_repeats\_to\_consume'}}
\DoxyCodeLine{00657\ \ \ \ \ \textcolor{comment}{//\ can\ be\ set\ to\ 0\ to\ peek\ at\ the\ value\ without\ consuming\ repeats.}}
\DoxyCodeLine{00658\ \ \ \ \ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a233a2e40e03d785d9d1fceb688668552}{GetRepeatedValue}}(int32\_t\ num\_repeats\_to\_consume);}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ \ \ \textcolor{comment}{//\ Return\ the\ size\ of\ the\ current\ literal\ run.\ Returns\ zero\ if\ the\ current\ run\ is}}
\DoxyCodeLine{00661\ \ \ \ \ \textcolor{comment}{//\ a\ repeated\ run\ or\ if\ no\ more\ runs\ can\ be\ read\ from\ the\ input.}}
\DoxyCodeLine{00662\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_ac59a33aa09f1987a38dea56b32f07736}{NextNumLiterals}}();}
\DoxyCodeLine{00663\ }
\DoxyCodeLine{00664\ \ \ \ \ \textcolor{comment}{//\ Consume\ 'num\_literals\_to\_consume'\ literals\ from\ the\ current\ literal\ run,}}
\DoxyCodeLine{00665\ \ \ \ \ \textcolor{comment}{//\ copying\ the\ values\ to\ 'values'.\ 'num\_literals\_to\_consume'\ must\ be\ <=}}
\DoxyCodeLine{00666\ \ \ \ \ \textcolor{comment}{//\ NextNumLiterals().\ Returns\ true\ if\ the\ requested\ number\ of\ literals\ were}}
\DoxyCodeLine{00667\ \ \ \ \ \textcolor{comment}{//\ successfully\ read\ or\ false\ if\ an\ error\ was\ encountered,\ e.g.\ the\ input\ was}}
\DoxyCodeLine{00668\ \ \ \ \ \textcolor{comment}{//\ truncated.}}
\DoxyCodeLine{00669\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a984440a4a3e0014a5af69dc7ca8f2e86}{GetLiteralValues}}(int32\_t\ num\_literals\_to\_consume,\ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values)\ \mbox{\hyperlink{status_8h_a4e0e2d9e1ee0f401844b5b6ff8338f82}{WARN\_UNUSED\_RESULT}};}
\DoxyCodeLine{00670\ }
\DoxyCodeLine{00671\ \ \ \ \ \textcolor{comment}{//\ Consume\ 'num\_values\_to\_consume'\ values\ and\ copy\ them\ to\ 'values'.}}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{comment}{//\ Returns\ the\ number\ of\ consumed\ values\ or\ 0\ if\ an\ error\ occurred.}}
\DoxyCodeLine{00673\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a7a7f049ecbbae509c516eb123be20525}{GetBatch}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values,\ int32\_t\ batch\_num);}
\DoxyCodeLine{00674\ }
\DoxyCodeLine{00675\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00676\ \ \ \ \ \textcolor{comment}{//\ Called\ when\ both\ 'literal\_count\_'\ and\ 'repeat\_count\_'\ have\ been\ exhausted.}}
\DoxyCodeLine{00677\ \ \ \ \ \textcolor{comment}{//\ Sets\ either\ 'literal\_count\_'\ or\ 'repeat\_count\_'\ to\ the\ size\ of\ the\ next\ literal}}
\DoxyCodeLine{00678\ \ \ \ \ \textcolor{comment}{//\ or\ repeated\ run,\ or\ leaves\ both\ at\ 0\ if\ no\ more\ values\ can\ be\ read\ (either\ because}}
\DoxyCodeLine{00679\ \ \ \ \ \textcolor{comment}{//\ the\ end\ of\ the\ input\ was\ reached\ or\ an\ error\ was\ encountered\ decoding).}}
\DoxyCodeLine{00680\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a10f78283557d52755e6d2da66cb112b4}{NextCounts}}();}
\DoxyCodeLine{00681\ }
\DoxyCodeLine{00684\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a1c5dc497d4e25b74518b69a6623a731f}{FillLiteralBuffer}}()\ \mbox{\hyperlink{status_8h_a4e0e2d9e1ee0f401844b5b6ff8338f82}{WARN\_UNUSED\_RESULT}};}
\DoxyCodeLine{00685\ }
\DoxyCodeLine{00686\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_acedb9900a0e51809d83d8af9d4e9c776}{HaveBufferedLiterals}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_aea1d4cfa3e041f15ecedb0b593c4758f}{literal\_buffer\_pos\_}}\ <\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_ad7c41e5084bdcf0f64b255df383a80e3}{num\_buffered\_literals\_}};\ \}}
\DoxyCodeLine{00687\ }
\DoxyCodeLine{00690\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_ac78261f7c467aafb520dd242a850e9f9}{OutputBufferedLiterals}}(int32\_t\ max\_to\_output,\ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values);}
\DoxyCodeLine{00691\ }
\DoxyCodeLine{00692\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_batched_bit_reader}{BatchedBitReader}}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a6feb2754f20868cdd6d8c4d4a488cff3}{bit\_reader\_}};}
\DoxyCodeLine{00693\ }
\DoxyCodeLine{00694\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ bits\ needed\ to\ encode\ the\ value.\ Must\ be\ between\ 0\ and\ 64\ after}}
\DoxyCodeLine{00695\ \ \ \ \ \textcolor{comment}{//\ the\ decoder\ is\ initialized\ with\ a\ buffer.\ -\/1\ indicates\ the\ decoder\ was\ not}}
\DoxyCodeLine{00696\ \ \ \ \ \textcolor{comment}{//\ initialized.}}
\DoxyCodeLine{00697\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_afe6221c200a0edcd3a03113e5aa559be}{bit\_width\_}}\ =\ -\/1;}
\DoxyCodeLine{00698\ }
\DoxyCodeLine{00699\ \ \ \ \ \textcolor{comment}{//\ If\ a\ repeated\ run,\ the\ number\ of\ repeats\ remaining\ in\ the\ current\ run\ to\ be\ read.}}
\DoxyCodeLine{00700\ \ \ \ \ \textcolor{comment}{//\ If\ the\ current\ run\ is\ a\ literal\ run,\ this\ is\ 0.}}
\DoxyCodeLine{00701\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_adbf99710e7bac5047cc26d7db91dd3be}{repeat\_count\_}}\ =\ 0;}
\DoxyCodeLine{00702\ }
\DoxyCodeLine{00703\ \ \ \ \ \textcolor{comment}{//\ If\ a\ literal\ run,\ the\ number\ of\ literals\ remaining\ in\ the\ current\ run\ to\ be\ read.}}
\DoxyCodeLine{00704\ \ \ \ \ \textcolor{comment}{//\ If\ the\ current\ run\ is\ a\ repeated\ run,\ this\ is\ 0.}}
\DoxyCodeLine{00705\ \ \ \ \ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a2dbcad7018281f46fc2259ea07a89d6e}{literal\_count\_}}\ =\ 0;}
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ \ \ \ \ \textcolor{comment}{//\ If\ a\ repeated\ run,\ the\ current\ repeated\ value.}}
\DoxyCodeLine{00708\ \ \ \ \ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a4e2c3f7bdc8d7781800ef339c568298b}{repeated\_value\_}};}
\DoxyCodeLine{00709\ }
\DoxyCodeLine{00710\ \ \ \ \ \textcolor{comment}{//\ Size\ of\ buffer\ for\ literal\ values.\ Large\ enough\ to\ decode\ a\ full\ batch\ of\ 32}}
\DoxyCodeLine{00711\ \ \ \ \ \textcolor{comment}{//\ literals.\ The\ buffer\ is\ needed\ to\ allow\ clients\ to\ read\ in\ batches\ that\ are\ not}}
\DoxyCodeLine{00712\ \ \ \ \ \textcolor{comment}{//\ multiples\ of\ 32.}}
\DoxyCodeLine{00713\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a6694a29d7c435e9e88937aa644e58a6f}{LITERAL\_BUFFER\_LEN}}\ =\ 32;}
\DoxyCodeLine{00714\ }
\DoxyCodeLine{00715\ \ \ \ \ \textcolor{comment}{//\ Buffer\ containing\ 'num\_buffered\_literals\_'\ values.\ 'literal\_buffer\_pos\_'\ is\ the}}
\DoxyCodeLine{00716\ \ \ \ \ \textcolor{comment}{//\ position\ of\ the\ next\ literal\ to\ be\ read\ from\ the\ buffer.}}
\DoxyCodeLine{00717\ \ \ \ \ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a9687c933d6552d13b5f857748431440a}{literal\_buffer\_}}[\mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a6694a29d7c435e9e88937aa644e58a6f}{LITERAL\_BUFFER\_LEN}}];}
\DoxyCodeLine{00718\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_ad7c41e5084bdcf0f64b255df383a80e3}{num\_buffered\_literals\_}}\ =\ 0;}
\DoxyCodeLine{00719\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_aea1d4cfa3e041f15ecedb0b593c4758f}{literal\_buffer\_pos\_}}\ =\ 0;}
\DoxyCodeLine{00720\ \};}
\DoxyCodeLine{00721\ }
\DoxyCodeLine{00722\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00723\ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_ac78261f7c467aafb520dd242a850e9f9}{RleBatchDecoder<T>::OutputBufferedLiterals}}(int32\_t\ max\_to\_output,\ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values)\ \{}
\DoxyCodeLine{00724\ \ \ \ \ int32\_t\ num\_to\_output\ =}
\DoxyCodeLine{00725\ \ \ \ \ \ \ \ \ \ \ \ \ std::min<int32\_t>(max\_to\_output,\ num\_buffered\_literals\_\ -\/\ literal\_buffer\_pos\_);}
\DoxyCodeLine{00726\ \ \ \ \ \mbox{\hyperlink{memcpy__aarch64_8cpp_a156c5821f16ed93be8c7d315303f7b2a}{memcpy}}(values,\ \&literal\_buffer\_[literal\_buffer\_pos\_],\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}})\ *\ num\_to\_output);}
\DoxyCodeLine{00727\ \ \ \ \ literal\_buffer\_pos\_\ +=\ num\_to\_output;}
\DoxyCodeLine{00728\ \ \ \ \ literal\_count\_\ -\/=\ num\_to\_output;}
\DoxyCodeLine{00729\ \ \ \ \ \textcolor{keywordflow}{return}\ num\_to\_output;}
\DoxyCodeLine{00730\ \}}
\DoxyCodeLine{00731\ }
\DoxyCodeLine{00732\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00733\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a7566d4aac3ac6f2025253a31b4ad5c8d}{RleBatchDecoder<T>::Reset}}(uint8\_t*\ buffer,\ \textcolor{keywordtype}{int}\ buffer\_len,\ \textcolor{keywordtype}{int}\ bit\_width)\ \{}
\DoxyCodeLine{00734\ \ \ \ \ bit\_reader\_.Reset(buffer,\ buffer\_len);}
\DoxyCodeLine{00735\ \ \ \ \ bit\_width\_\ =\ bit\_width;}
\DoxyCodeLine{00736\ \ \ \ \ repeat\_count\_\ =\ 0;}
\DoxyCodeLine{00737\ \ \ \ \ literal\_count\_\ =\ 0;}
\DoxyCodeLine{00738\ \ \ \ \ num\_buffered\_literals\_\ =\ 0;}
\DoxyCodeLine{00739\ \ \ \ \ literal\_buffer\_pos\_\ =\ 0;}
\DoxyCodeLine{00740\ \}}
\DoxyCodeLine{00741\ }
\DoxyCodeLine{00742\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00743\ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_afbb581660ee9b6821d2a19a83b5f5062}{RleBatchDecoder<T>::NextNumRepeats}}()\ \{}
\DoxyCodeLine{00744\ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ >\ 0)\ \textcolor{keywordflow}{return}\ repeat\_count\_;}
\DoxyCodeLine{00745\ \ \ \ \ \textcolor{keywordflow}{if}\ (literal\_count\_\ ==\ 0)\ NextCounts();}
\DoxyCodeLine{00746\ \ \ \ \ \textcolor{keywordflow}{return}\ repeat\_count\_;}
\DoxyCodeLine{00747\ \}}
\DoxyCodeLine{00748\ }
\DoxyCodeLine{00749\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00750\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a10f78283557d52755e6d2da66cb112b4}{RleBatchDecoder<T>::NextCounts}}()\ \{}
\DoxyCodeLine{00751\ \ \ \ \ \textcolor{comment}{//\ Read\ the\ next\ run's\ indicator\ int,\ it\ could\ be\ a\ literal\ or\ repeated\ run.}}
\DoxyCodeLine{00752\ \ \ \ \ \textcolor{comment}{//\ The\ int\ is\ encoded\ as\ a\ ULEB128-\/encoded\ value.}}
\DoxyCodeLine{00753\ \ \ \ \ uint32\_t\ indicator\_value\ =\ 0;}
\DoxyCodeLine{00754\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(!bit\_reader\_.GetUleb128<uint32\_t>(\&indicator\_value)))\ \{}
\DoxyCodeLine{00755\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00756\ \ \ \ \ \}}
\DoxyCodeLine{00757\ }
\DoxyCodeLine{00758\ \ \ \ \ \textcolor{comment}{//\ lsb\ indicates\ if\ it\ is\ a\ literal\ run\ or\ repeated\ run}}
\DoxyCodeLine{00759\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{glob_8c_a9fe0e9477958d30ae57464929ca22f34}{is\_literal}}\ =\ indicator\_value\ \&\ 1;}
\DoxyCodeLine{00760\ }
\DoxyCodeLine{00761\ \ \ \ \ \textcolor{comment}{//\ Don't\ try\ to\ handle\ run\ lengths\ that\ don't\ fit\ in\ an\ int32\_t\ -\/\ just\ fail\ gracefully.}}
\DoxyCodeLine{00762\ \ \ \ \ \textcolor{comment}{//\ The\ Parquet\ standard\ does\ not\ allow\ longer\ runs\ -\/\ see\ PARQUET-\/1290.}}
\DoxyCodeLine{00763\ \ \ \ \ uint32\_t\ run\_len\ =\ indicator\_value\ >>\ 1;}
\DoxyCodeLine{00764\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{glob_8c_a9fe0e9477958d30ae57464929ca22f34}{is\_literal}})\ \{}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Use\ int64\_t\ to\ avoid\ overflowing\ multiplication.}}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \ \ int64\_t\ literal\_count\ =\ \textcolor{keyword}{static\_cast<}int64\_t\textcolor{keyword}{>}(run\_len)\ *\ 8;}
\DoxyCodeLine{00767\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(literal\_count\ >\ std::numeric\_limits<int32\_t>::max()))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00768\ \ \ \ \ \ \ \ \ literal\_count\_\ =\ literal\_count;}
\DoxyCodeLine{00769\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(run\_len\ ==\ 0))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ bit\_reader\_.GetBytes<\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}>(\mbox{\hyperlink{classdoris_1_1_bit_util_ab9002e6aac9b818996faf615f08e426a}{BitUtil::Ceil}}(bit\_width\_,\ 8),\ \&repeated\_value\_);}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(!result))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \ \ repeat\_count\_\ =\ run\_len;}
\DoxyCodeLine{00774\ \ \ \ \ \}}
\DoxyCodeLine{00775\ \}}
\DoxyCodeLine{00776\ }
\DoxyCodeLine{00777\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00778\ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a233a2e40e03d785d9d1fceb688668552}{RleBatchDecoder<T>::GetRepeatedValue}}(int32\_t\ num\_repeats\_to\_consume)\ \{}
\DoxyCodeLine{00779\ \ \ \ \ repeat\_count\_\ -\/=\ num\_repeats\_to\_consume;}
\DoxyCodeLine{00780\ \ \ \ \ \textcolor{keywordflow}{return}\ repeated\_value\_;}
\DoxyCodeLine{00781\ \}}
\DoxyCodeLine{00782\ }
\DoxyCodeLine{00783\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00784\ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_ac59a33aa09f1987a38dea56b32f07736}{RleBatchDecoder<T>::NextNumLiterals}}()\ \{}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{keywordflow}{if}\ (literal\_count\_\ >\ 0)\ \textcolor{keywordflow}{return}\ literal\_count\_;}
\DoxyCodeLine{00786\ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_count\_\ ==\ 0)\ NextCounts();}
\DoxyCodeLine{00787\ \ \ \ \ \textcolor{keywordflow}{return}\ literal\_count\_;}
\DoxyCodeLine{00788\ \}}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00790\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00791\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a984440a4a3e0014a5af69dc7ca8f2e86}{RleBatchDecoder<T>::GetLiteralValues}}(int32\_t\ num\_literals\_to\_consume,\ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values)\ \{}
\DoxyCodeLine{00792\ \ \ \ \ int32\_t\ num\_consumed\ =\ 0;}
\DoxyCodeLine{00793\ \ \ \ \ \textcolor{comment}{//\ Copy\ any\ buffered\ literals\ left\ over\ from\ previous\ calls.}}
\DoxyCodeLine{00794\ \ \ \ \ \textcolor{keywordflow}{if}\ (HaveBufferedLiterals())\ \{}
\DoxyCodeLine{00795\ \ \ \ \ \ \ \ \ num\_consumed\ =\ OutputBufferedLiterals(num\_literals\_to\_consume,\ values);}
\DoxyCodeLine{00796\ \ \ \ \ \}}
\DoxyCodeLine{00797\ }
\DoxyCodeLine{00798\ \ \ \ \ int32\_t\ num\_remaining\ =\ num\_literals\_to\_consume\ -\/\ num\_consumed;}
\DoxyCodeLine{00799\ \ \ \ \ \textcolor{comment}{//\ Copy\ literals\ directly\ to\ the\ output,\ bypassing\ 'literal\_buffer\_'\ when\ possible.}}
\DoxyCodeLine{00800\ \ \ \ \ \textcolor{comment}{//\ Need\ to\ round\ to\ a\ batch\ of\ 32\ if\ the\ caller\ is\ consuming\ only\ part\ of\ the\ current}}
\DoxyCodeLine{00801\ \ \ \ \ \textcolor{comment}{//\ run\ avoid\ ending\ on\ a\ non-\/byte\ boundary.}}
\DoxyCodeLine{00802\ \ \ \ \ int32\_t\ num\_to\_bypass\ =}
\DoxyCodeLine{00803\ \ \ \ \ \ \ \ \ \ \ \ \ std::min<int32\_t>(literal\_count\_,\ \mbox{\hyperlink{classdoris_1_1_bit_util_a53a4f8a3ed22943a338725ad02aac84d}{BitUtil::RoundDownToPowerOf2}}(num\_remaining,\ 32));}
\DoxyCodeLine{00804\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_to\_bypass\ >\ 0)\ \{}
\DoxyCodeLine{00805\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_read\ =\ bit\_reader\_.UnpackBatch(bit\_width\_,\ num\_to\_bypass,\ values\ +\ num\_consumed);}
\DoxyCodeLine{00806\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ couldn't\ read\ the\ expected\ number,\ that\ means\ the\ input\ was\ truncated.}}
\DoxyCodeLine{00807\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_read\ <\ num\_to\_bypass)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00808\ \ \ \ \ \ \ \ \ literal\_count\_\ -\/=\ num\_to\_bypass;}
\DoxyCodeLine{00809\ \ \ \ \ \ \ \ \ num\_consumed\ +=\ num\_to\_bypass;}
\DoxyCodeLine{00810\ \ \ \ \ \ \ \ \ num\_remaining\ =\ num\_literals\_to\_consume\ -\/\ num\_consumed;}
\DoxyCodeLine{00811\ \ \ \ \ \}}
\DoxyCodeLine{00812\ }
\DoxyCodeLine{00813\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_remaining\ >\ 0)\ \{}
\DoxyCodeLine{00814\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ weren't\ able\ to\ copy\ all\ the\ literals\ requested\ directly\ from\ the\ input.}}
\DoxyCodeLine{00815\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Buffer\ literals\ and\ copy\ over\ the\ requested\ number.}}
\DoxyCodeLine{00816\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(!FillLiteralBuffer()))\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00817\ \ \ \ \ \ \ \ \ OutputBufferedLiterals(num\_remaining,\ values\ +\ num\_consumed);}
\DoxyCodeLine{00818\ \ \ \ \ \}}
\DoxyCodeLine{00819\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00820\ \}}
\DoxyCodeLine{00821\ }
\DoxyCodeLine{00822\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00823\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a1c5dc497d4e25b74518b69a6623a731f}{RleBatchDecoder<T>::FillLiteralBuffer}}()\ \{}
\DoxyCodeLine{00824\ \ \ \ \ int32\_t\ num\_to\_buffer\ =\ std::min<int32\_t>(LITERAL\_BUFFER\_LEN,\ literal\_count\_);}
\DoxyCodeLine{00825\ \ \ \ \ num\_buffered\_literals\_\ =\ bit\_reader\_.UnpackBatch(bit\_width\_,\ num\_to\_buffer,\ literal\_buffer\_);}
\DoxyCodeLine{00826\ \ \ \ \ \textcolor{comment}{//\ If\ we\ couldn't\ read\ the\ expected\ number,\ that\ means\ the\ input\ was\ truncated.}}
\DoxyCodeLine{00827\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(num\_buffered\_literals\_\ <\ num\_to\_buffer))\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00828\ \ \ \ \ literal\_buffer\_pos\_\ =\ 0;}
\DoxyCodeLine{00829\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00830\ \}}
\DoxyCodeLine{00831\ }
\DoxyCodeLine{00832\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00833\ int32\_t\ \mbox{\hyperlink{classdoris_1_1_rle_batch_decoder_a7a7f049ecbbae509c516eb123be20525}{RleBatchDecoder<T>::GetBatch}}(\mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}*\ values,\ int32\_t\ batch\_num)\ \{}
\DoxyCodeLine{00834\ \ \ \ \ int32\_t\ num\_consumed\ =\ 0;}
\DoxyCodeLine{00835\ \ \ \ \ \textcolor{keywordflow}{while}\ (num\_consumed\ <\ batch\_num)\ \{}
\DoxyCodeLine{00836\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ RLE\ encoded\ values\ by\ repeating\ the\ current\ value\ this\ number\ of\ times.}}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \ \ int32\_t\ num\_repeats\ =\ NextNumRepeats();}
\DoxyCodeLine{00838\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_repeats\ >\ 0)\ \{}
\DoxyCodeLine{00839\ \ \ \ \ \ \ \ \ \ \ \ \ int32\_t\ num\_repeats\_to\_set\ =\ std::min(num\_repeats,\ batch\_num\ -\/\ num\_consumed);}
\DoxyCodeLine{00840\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{exp_8c_a0acb682b8260ab1c60b918599864e2e5}{T}}\ repeated\_value\ =\ GetRepeatedValue(num\_repeats\_to\_set);}
\DoxyCodeLine{00841\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_repeats\_to\_set;\ ++i)\ \{}
\DoxyCodeLine{00842\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ values[num\_consumed\ +\ i]\ =\ repeated\_value;}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00844\ \ \ \ \ \ \ \ \ \ \ \ \ num\_consumed\ +=\ num\_repeats\_to\_set;}
\DoxyCodeLine{00845\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00846\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00847\ }
\DoxyCodeLine{00848\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ remaining\ literal\ values,\ if\ any.}}
\DoxyCodeLine{00849\ \ \ \ \ \ \ \ \ int32\_t\ num\_literals\ =\ NextNumLiterals();}
\DoxyCodeLine{00850\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_literals\ ==\ 0)\ \{}
\DoxyCodeLine{00851\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00852\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00853\ \ \ \ \ \ \ \ \ int32\_t\ num\_literals\_to\_set\ =\ std::min(num\_literals,\ batch\_num\ -\/\ num\_consumed);}
\DoxyCodeLine{00854\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!GetLiteralValues(num\_literals\_to\_set,\ values\ +\ num\_consumed))\ \{}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00856\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \ \ num\_consumed\ +=\ num\_literals\_to\_set;}
\DoxyCodeLine{00858\ \ \ \ \ \}}
\DoxyCodeLine{00859\ \ \ \ \ \textcolor{keywordflow}{return}\ num\_consumed;}
\DoxyCodeLine{00860\ \}}
\DoxyCodeLine{00861\ }
\DoxyCodeLine{00862\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
