\hypertarget{mem__pool_8h_source}{}\doxysection{mem\+\_\+pool.\+h}
\label{mem__pool_8h_source}\index{/Users/dabowang/be\_all/runtime/mem\_pool.h@{/Users/dabowang/be\_all/runtime/mem\_pool.h}}
\mbox{\hyperlink{mem__pool_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ \textcolor{comment}{//\ This\ file\ is\ copied\ from}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ https://github.com/apache/impala/blob/branch-\/2.9.0/be/src/runtime/mem-\/pool.h}}
\DoxyCodeLine{00019\ \textcolor{comment}{//\ and\ modified\ by\ Doris}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ <cstddef>}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{common_2config_8h}{common/config.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{logging_8h}{common/logging.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{status_8h}{common/status.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dynamic__annotations_8h}{gutil/dynamic\_annotations.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{olap__define_8h}{olap/olap\_define.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{exec__env_8h}{runtime/exec\_env.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{chunk_8h}{runtime/memory/chunk.h}}"{}}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{thread__context_8h}{runtime/thread\_context.h}}"{}}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bit__util_8h}{util/bit\_util.h}}"{}}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{keyword}{class\ }MemTracker;}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00048\ \textcolor{comment}{//}}
\DoxyCodeLine{00053\ \textcolor{comment}{}\textcolor{comment}{//}}
\DoxyCodeLine{00087\ \textcolor{comment}{}\textcolor{comment}{//}}
\DoxyCodeLine{00094\ \textcolor{comment}{}\textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_mem_pool}{MemPool}}\ \{}
\DoxyCodeLine{00095\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{comment}{//\ 'tracker'\ tracks\ the\ amount\ of\ memory\ allocated\ by\ this\ pool.\ Must\ not\ be\ nullptr.}}
\DoxyCodeLine{00097\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_mem_pool_a42145941c12bbb94e798490e14f940f4}{MemPool}}(\mbox{\hyperlink{classdoris_1_1_mem_tracker}{MemTracker}}*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a3784f1d2cedbd86999122cf6b1419e81}{mem\_tracker}});}
\DoxyCodeLine{00098\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_mem_pool_a42145941c12bbb94e798490e14f940f4}{MemPool}}();}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00102\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_mem_pool_a5d9436e563027071fb7f5471f26af32c}{\string~MemPool}}();}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00107\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a6bbe6a57173c878bdb87ee90c87022a9}{allocate}}(int64\_t\ size,\ \textcolor{keywordtype}{bool}\ free\_old\_chunks\ =\ \textcolor{keyword}{false})\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ allocate<false>(size,\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55e30d64539971321c58aa1a26d8b671}{DEFAULT\_ALIGNMENT}},\ free\_old\_chunks);}
\DoxyCodeLine{00109\ \ \ \ \ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_ae6c8a9fd44a082f7172774fa2592c89b}{allocate\_aligned}}(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment)\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ DCHECK\_GE(alignment,\ 1);}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ DCHECK\_LE(alignment,\ config::memory\_max\_alignment);}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ DCHECK\_EQ(\mbox{\hyperlink{classdoris_1_1_bit_util_a902de2e24d25240c645914792e1b09de}{BitUtil::RoundUpToPowerOfTwo}}(alignment),\ alignment);}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ allocate<false>(size,\ alignment);}
\DoxyCodeLine{00116\ \ \ \ \ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00119\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a09fa199573f5b5e14ccbf12b75d7dc1c}{allocate\_safely}}(int64\_t\ size,\ uint8\_t*\&\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}})\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ allocate\_safely<false>(size,\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55e30d64539971321c58aa1a26d8b671}{DEFAULT\_ALIGNMENT}},\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}});}
\DoxyCodeLine{00121\ \ \ \ \ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00127\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a77c864da08b18a7f329ea3a4f03d3a49}{try\_allocate}}(int64\_t\ size)\ \{\ \textcolor{keywordflow}{return}\ allocate<true>(size,\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55e30d64539971321c58aa1a26d8b671}{DEFAULT\_ALIGNMENT}});\ \}}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00131\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a593527fbb6f92934decc5c9971e6a6ed}{try\_allocate\_aligned}}(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment)\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ DCHECK\_GE(alignment,\ 1);}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ DCHECK\_LE(alignment,\ config::memory\_max\_alignment);}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ DCHECK\_EQ(\mbox{\hyperlink{classdoris_1_1_bit_util_a902de2e24d25240c645914792e1b09de}{BitUtil::RoundUpToPowerOfTwo}}(alignment),\ alignment);}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ allocate<true>(size,\ alignment);}
\DoxyCodeLine{00136\ \ \ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00139\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a6d26bcac68a4840a8aed98fe68998980}{try\_allocate\_unaligned}}(int64\_t\ size)\ \{}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Call\ templated\ implementation\ directly\ so\ that\ it\ is\ inlined\ here\ and\ the}}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ alignment\ logic\ can\ be\ optimised\ out.}}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ allocate<true>(size,\ 1);}
\DoxyCodeLine{00143\ \ \ \ \ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_ac8bb3912a3ce86b15842e79d0b421204}{clear}}();}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_af4de2f83436cd4ed6744ced00335545a}{free\_all}}();}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a8390fe0aaec400317015c6c6f4c885b2}{acquire\_data}}(\mbox{\hyperlink{classdoris_1_1_mem_pool}{MemPool}}*\ src,\ \textcolor{keywordtype}{bool}\ keep\_current);}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \ \ \ \ std::string\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a4dcb28d0641b6d37aef23c662ec11908}{debug\_string}}();}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1_mem_pool_ac2c82d6ddaca81b4a1fbea56357a56a0}{total\_allocated\_bytes}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a5999667e31d6e6cd3dfbae837e52d2f1}{total\_allocated\_bytes\_}};\ \}}
\DoxyCodeLine{00160\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1_mem_pool_aa18c7f597cda80b68976807afee3ccae}{total\_reserved\_bytes}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a8207c0d5e43fdd326d0064ea5f5a76d7}{total\_reserved\_bytes\_}};\ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_mem_tracker}{MemTracker}}*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a3784f1d2cedbd86999122cf6b1419e81}{mem\_tracker}}()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_aeb56efb11f09c22f1a97a0238206da30}{\_mem\_tracker}};\ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{comment}{//\ The\ memory\ for\ \_\_int128\ should\ be\ aligned\ to\ 16\ bytes.}}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ By\ the\ way,\ in\ 64-\/bit\ system,\ the\ address\ of\ a\ block\ returned\ by\ malloc\ or\ realloc\ in\ GNU\ systems}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ is\ always\ a\ multiple\ of\ sixteen.\ (https://www.gnu.org/software/libc/manual/html\_node/Aligned-\/Memory-\/Blocks.html)}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55e30d64539971321c58aa1a26d8b671}{DEFAULT\_ALIGNMENT}}\ =\ 16;}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \textcolor{preprocessor}{\#if\ (defined(\_\_SANITIZE\_ADDRESS\_\_)\ ||\ defined(ADDRESS\_SANITIZER))\ \&\&\ !defined(BE\_TEST)}}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a23ec6fd4aacd7be3f89a40feab9b4539}{DEFAULT\_PADDING\_SIZE}}\ =\ 0x10;}
\DoxyCodeLine{00171\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a23ec6fd4aacd7be3f89a40feab9b4539}{DEFAULT\_PADDING\_SIZE}}\ =\ 0x0;}
\DoxyCodeLine{00173\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_mem_pool_a322861f486366e94b973dd022ab523a8}{MemPoolTest}};}
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a0b66ea488b861cbafd4a896fbd931422}{INITIAL\_CHUNK\_SIZE}}\ =\ 4\ *\ 1024;}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_ae966c6584335ae929dbd77531ebcf301}{MAX\_CHUNK\_SIZE}}\ =\ 512\ *\ 1024;}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info}{ChunkInfo}}\ \{}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_chunk}{Chunk}}\ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a098888421f1a4118613fbc0f6cfa4f62}{chunk}};}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ int64\_t\ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_ab0a531c5c18b9871f5cd77e0b452c0fb}{allocated\_bytes}};}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a4bfca998ca75e5def0908d4a1d86041b}{ChunkInfo}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structdoris_1_1_chunk}{Chunk}}\&\ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a098888421f1a4118613fbc0f6cfa4f62}{chunk}});}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a4bfca998ca75e5def0908d4a1d86041b}{ChunkInfo}}()\ :\ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_ab0a531c5c18b9871f5cd77e0b452c0fb}{allocated\_bytes}}(0)\ \{\}}
\DoxyCodeLine{00189\ \ \ \ \ \};}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keyword}{static}\ uint32\_t\ \mbox{\hyperlink{classdoris_1_1_mem_pool_ab6dd0f9c2f7f6a29a032ab185d4e700f}{k\_zero\_length\_region\_}};}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00201\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a496b30429df7da46fc8fdc8cd6ffa680}{find\_chunk}}(\textcolor{keywordtype}{size\_t}\ min\_size,\ \textcolor{keywordtype}{bool}\ check\_limits,\ \textcolor{keywordtype}{bool}\ free\_old\_chunks);}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a6b20ce905b38d4fdd3d623e2d1fad9b2}{check\_integrity}}(\textcolor{keywordtype}{bool}\ check\_current\_chunk\_empty);}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00210\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a3c2ed43ca91dcc971913c2a307df6d77}{get\_free\_offset}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classdoris_1_1_mem_pool_aed7d68711317ab1df2c91ff520320321}{current\_chunk\_idx\_}}\ ==\ -\/1)\ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a481f648c78e8f8ac2912c950c0f34e6c}{chunks\_}}[\mbox{\hyperlink{classdoris_1_1_mem_pool_aed7d68711317ab1df2c91ff520320321}{current\_chunk\_idx\_}}].allocated\_bytes;}
\DoxyCodeLine{00213\ \ \ \ \ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55575a1816c844dbbaf0dba2cd0af4c0}{allocate\_from\_current\_chunk}}(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment)\ \{}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Manually\ ASAN\ poisoning\ is\ complicated\ and\ it\ is\ hard\ to\ make}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ it\ work\ right.\ There\ are\ illustrated\ examples\ in}}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ http://blog.hostilefork.com/poison-\/memory-\/without-\/asan/.}}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Stacks\ of\ use\ after\ poison\ do\ not\ provide\ enough\ information}}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ resolve\ bug,\ while\ stacks\ of\ use\ afer\ free\ provide.}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ https://github.com/google/sanitizers/issues/191}}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We'd\ better\ implement\ a\ mempool\ using\ malloc/free\ directly,}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ thus\ asan\ works\ natively.\ However\ we\ cannot\ do\ it\ in\ a\ short}}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ time,\ so\ we\ make\ manual\ poisoning\ work\ as\ much\ as\ possible.}}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ I\ refers\ to\ https://github.com/mcgov/asan\_alignment\_example.}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info}{ChunkInfo}}\&\ info\ =\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a481f648c78e8f8ac2912c950c0f34e6c}{chunks\_}}[\mbox{\hyperlink{classdoris_1_1_mem_pool_aed7d68711317ab1df2c91ff520320321}{current\_chunk\_idx\_}}];}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ int64\_t\ aligned\_allocated\_bytes\ =}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_bit_util_a78eec419054f5bf209800369b0a63506}{BitUtil::RoundUpToPowerOf2}}(info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_ab0a531c5c18b9871f5cd77e0b452c0fb}{allocated\_bytes}}\ +\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a23ec6fd4aacd7be3f89a40feab9b4539}{DEFAULT\_PADDING\_SIZE}},\ alignment);}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (aligned\_allocated\_bytes\ +\ size\ <=\ info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a098888421f1a4118613fbc0f6cfa4f62}{chunk}}.\mbox{\hyperlink{structdoris_1_1_chunk_a854352f53b148adc24983a58a1866d66}{size}})\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Ensure\ the\ requested\ alignment\ is\ respected.}}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ int64\_t\ padding\ =\ aligned\_allocated\_bytes\ -\/\ info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_ab0a531c5c18b9871f5cd77e0b452c0fb}{allocated\_bytes}};}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t*\ result\ =\ info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a098888421f1a4118613fbc0f6cfa4f62}{chunk}}.\mbox{\hyperlink{structdoris_1_1_chunk_abe222f6d3581e7920dcad5306cc906a8}{data}}\ +\ aligned\_allocated\_bytes;}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dynamic__annotations_8h_a7a3f4306ff3c7076441d1aafd6c1c22c}{ASAN\_UNPOISON\_MEMORY\_REGION}}(result,\ size);}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_LE(info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_ab0a531c5c18b9871f5cd77e0b452c0fb}{allocated\_bytes}}\ +\ size,\ info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_a098888421f1a4118613fbc0f6cfa4f62}{chunk}}.\mbox{\hyperlink{structdoris_1_1_chunk_a854352f53b148adc24983a58a1866d66}{size}});}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \ \ info.\mbox{\hyperlink{structdoris_1_1_mem_pool_1_1_chunk_info_ab0a531c5c18b9871f5cd77e0b452c0fb}{allocated\_bytes}}\ +=\ padding\ +\ size;}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_mem_pool_a5999667e31d6e6cd3dfbae837e52d2f1}{total\_allocated\_bytes\_}}\ +=\ padding\ +\ size;}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ DCHECK\_LE(\mbox{\hyperlink{classdoris_1_1_mem_pool_aed7d68711317ab1df2c91ff520320321}{current\_chunk\_idx\_}},\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a481f648c78e8f8ac2912c950c0f34e6c}{chunks\_}}.size()\ -\/\ 1);}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00244\ \ \ \ \ \}}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ CHECK\_LIMIT\_FIRST>}
\DoxyCodeLine{00247\ \ \ \ \ uint8\_t*\ \mbox{\hyperlink{compiler__util_8h_aa1dec568e79152c892dcf63f445cbd7a}{ALWAYS\_INLINE}}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_abcb9972328c7f8747a778c0969829d1a}{allocate}}(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment,\ \textcolor{keywordtype}{bool}\ free\_old\_chunks\ =\ \textcolor{keyword}{false})\ \{}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ DCHECK\_GE(size,\ 0);}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(size\ ==\ 0))\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{reinterpret\_cast<}uint8\_t*\textcolor{keyword}{>}(\&\mbox{\hyperlink{classdoris_1_1_mem_pool_ab6dd0f9c2f7f6a29a032ab185d4e700f}{k\_zero\_length\_region\_}});}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classdoris_1_1_mem_pool_aed7d68711317ab1df2c91ff520320321}{current\_chunk\_idx\_}}\ !=\ -\/1)\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t*\ result\ =\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55575a1816c844dbbaf0dba2cd0af4c0}{allocate\_from\_current\_chunk}}(size,\ alignment);}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00257\ }
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ couldn't\ allocate\ a\ new\ chunk,\ return\ nullptr.\ malloc()\ guarantees\ alignment}}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ of\ alignof(std::max\_align\_t),\ so\ we\ do\ not\ need\ to\ do\ anything\ additional\ to}}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ guarantee\ alignment.}}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \textcolor{comment}{//static\_assert(}}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \textcolor{comment}{//INITIAL\_CHUNK\_SIZE\ >=\ config::FLAGS\_MEMORY\_MAX\_ALIGNMENT,\ "{}Min\ chunk\ size\ too\ low"{});}}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{compiler__util_8h_a9acc330d508b9a3b775cfdf7ce405e7d}{UNLIKELY}}(!\mbox{\hyperlink{classdoris_1_1_mem_pool_a496b30429df7da46fc8fdc8cd6ffa680}{find\_chunk}}(size\ +\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a23ec6fd4aacd7be3f89a40feab9b4539}{DEFAULT\_PADDING\_SIZE}},\ CHECK\_LIMIT\_FIRST,\ free\_old\_chunks)))}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ uint8\_t*\ result\ =\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a55575a1816c844dbbaf0dba2cd0af4c0}{allocate\_from\_current\_chunk}}(size,\ alignment);}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00268\ \ \ \ \ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ CHECK\_LIMIT\_FIRST>}
\DoxyCodeLine{00271\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{compiler__util_8h_aa1dec568e79152c892dcf63f445cbd7a}{ALWAYS\_INLINE}}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a742414fe4ed173877a599b5b44c509c5}{allocate\_safely}}(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment,\ uint8\_t*\&\ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}})\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ uint8\_t*\ result\ =\ allocate<CHECK\_LIMIT\_FIRST>(size,\ alignment);}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status::Error<ErrorCode::MEM\_ALLOC\_FAILED>();}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{doris__main_8cpp_ab07b31d4e8924e322ffed3f51d39e425}{ret}}\ =\ result;}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_status_a6ec1a217f203269ab53d2290d602db24}{Status::OK}}();}
\DoxyCodeLine{00278\ \ \ \ \ \}}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00280\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00287\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_aed7d68711317ab1df2c91ff520320321}{current\_chunk\_idx\_}};}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a960c7e4aa89884aae5bc4ba96cc74167}{next\_chunk\_size\_}};}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00293\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a5999667e31d6e6cd3dfbae837e52d2f1}{total\_allocated\_bytes\_}};}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00296\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a8207c0d5e43fdd326d0064ea5f5a76d7}{total\_reserved\_bytes\_}};}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \ \ std::vector<ChunkInfo>\ \mbox{\hyperlink{classdoris_1_1_mem_pool_a481f648c78e8f8ac2912c950c0f34e6c}{chunks\_}};}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00302\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_mem_tracker}{MemTracker}}*\ \mbox{\hyperlink{classdoris_1_1_mem_pool_aeb56efb11f09c22f1a97a0238206da30}{\_mem\_tracker}};}
\DoxyCodeLine{00303\ \};}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00305\ \textcolor{comment}{//\ Stamp\ out\ templated\ implementations\ here\ so\ they're\ included\ in\ IR\ module}}
\DoxyCodeLine{00306\ \textcolor{keyword}{template}\ uint8\_t*\ MemPool::allocate<false>(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment,\ \textcolor{keywordtype}{bool}\ free\_old\_chunks);}
\DoxyCodeLine{00307\ \textcolor{keyword}{template}\ uint8\_t*\ MemPool::allocate<true>(int64\_t\ size,\ \textcolor{keywordtype}{int}\ alignment,\ \textcolor{keywordtype}{bool}\ free\_old\_chunks);}
\DoxyCodeLine{00308\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
