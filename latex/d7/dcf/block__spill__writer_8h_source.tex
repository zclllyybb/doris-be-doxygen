\hypertarget{block__spill__writer_8h_source}{}\doxysection{block\+\_\+spill\+\_\+writer.\+h}
\label{block__spill__writer_8h_source}\index{/Users/dabowang/doris/be/src/vec/core/block\_spill\_writer.h@{/Users/dabowang/doris/be/src/vec/core/block\_spill\_writer.h}}
\mbox{\hyperlink{block__spill__writer_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{local__file__writer_8h}{io/fs/local\_file\_writer.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{block_8h}{vec/core/block.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00023\ \textcolor{keyword}{namespace\ }vectorized\ \{}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{comment}{//\ Write\ a\ block\ to\ a\ local\ file.}}
\DoxyCodeLine{00026\ \textcolor{comment}{//}}
\DoxyCodeLine{00027\ \textcolor{comment}{//\ The\ block\ may\ be\ logically\ splitted\ to\ small\ sub\ blocks\ in\ the\ single\ file,}}
\DoxyCodeLine{00028\ \textcolor{comment}{//\ which\ can\ be\ read\ back\ one\ small\ block\ at\ a\ time\ by\ BlockSpillReader::read.}}
\DoxyCodeLine{00029\ \textcolor{comment}{//}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\ Split\ to\ small\ blocks\ is\ necessary\ for\ Sort\ node,\ which\ need\ to\ merge\ multiple}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ spilled\ big\ sorted\ blocks\ into\ a\ bigger\ sorted\ block.\ A\ small\ block\ is\ read\ from\ each}}
\DoxyCodeLine{00032\ \textcolor{comment}{//\ spilled\ block\ file\ each\ time.}}
\DoxyCodeLine{00033\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer}{BlockSpillWriter}}\ \{}
\DoxyCodeLine{00034\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00035\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a74c771cad072a0d1bc36eb499fa010c4}{BlockSpillWriter}}(int64\_t\ \textcolor{keywordtype}{id},\ \textcolor{keywordtype}{size\_t}\ batch\_size,\ \textcolor{keyword}{const}\ std::string\&\ file\_path,}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile}{RuntimeProfile}}*\ profile)}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_aeaaf268d2f3fb77ec5fd46eebb937f44}{stream\_id\_}}(id),\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a1cef95451b492c7ef95d28abdf3db2d2}{batch\_size\_}}(batch\_size),\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a02e2ecb860d1adca1967869a75d7208e}{file\_path\_}}(file\_path),\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a20ee14efca6695cccc9e8f2dab52d8b2}{profile\_}}(profile)\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a56cda409a338385130d676429fbdd899}{\_init\_profile}}();}
\DoxyCodeLine{00039\ \ \ \ \ \}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_ad415e0fb178adcd36f2452c81c69fd27}{\string~BlockSpillWriter}}()\ \{\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_aee1c6f7d85af14d039dec07dc31ae862}{close}}();\ \}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_afbfe7ce3274db0eff63382a83d559439}{open}}();}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_aee1c6f7d85af14d039dec07dc31ae862}{close}}();}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a5e7166e0e9f0780bcd9ce6c09a0be095}{write}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}\&\ block);}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a9693d17e17e20c78982d2345345e0a9a}{get\_id}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_aeaaf268d2f3fb77ec5fd46eebb937f44}{stream\_id\_}};\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a6b0350187c12864a2a026d7c3e92a367}{get\_written\_bytes}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a128e892843d440281afcf6eb8e340366}{total\_written\_bytes\_}};\ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a56cda409a338385130d676429fbdd899}{\_init\_profile}}();}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_aa876d39e33285dbdad0a9930808e9ae5}{\_write\_internal}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}\&\ block);}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_ac48966f6a195174614de729876c6d1fa}{is\_open\_}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00060\ \ \ \ \ int64\_t\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_aeaaf268d2f3fb77ec5fd46eebb937f44}{stream\_id\_}};}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a1cef95451b492c7ef95d28abdf3db2d2}{batch\_size\_}};}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a2026c88f362d9c209ef6d898123ad558}{max\_sub\_block\_size\_}}\ =\ 0;}
\DoxyCodeLine{00063\ \ \ \ \ std::string\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a02e2ecb860d1adca1967869a75d7208e}{file\_path\_}};}
\DoxyCodeLine{00064\ \ \ \ \ std::unique\_ptr<doris::io::FileWriter>\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_af93f48db75f8f21c856bb18b45e47c81}{file\_writer\_}};}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_ac1ad911cf0544f8059b2acf85750c8d8}{written\_blocks\_}}\ =\ 0;}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a128e892843d440281afcf6eb8e340366}{total\_written\_bytes\_}}\ =\ 0;}
\DoxyCodeLine{00068\ \ \ \ \ std::string\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a48f7d554d98aee457bcaf6a5df5ad83b}{meta\_}};}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a5ad2e9931e9216883c3bd956df4a66f1}{is\_first\_write\_}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00071\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block}{Block}}\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a6ab948b43134eea2bf2ad6ab8c7c843e}{tmp\_block\_}};}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile}{RuntimeProfile}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a20ee14efca6695cccc9e8f2dab52d8b2}{profile\_}}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00074\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile_1_1_counter}{RuntimeProfile::Counter}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_ac1810784ac2d3d9b964142b9cb930ef6}{write\_bytes\_counter\_}};}
\DoxyCodeLine{00075\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile_1_1_counter}{RuntimeProfile::Counter}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_ad6231597e7d286e09184e4746266e431}{serialize\_timer\_}};}
\DoxyCodeLine{00076\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_profile_1_1_counter}{RuntimeProfile::Counter}}*\ \mbox{\hyperlink{classdoris_1_1vectorized_1_1_block_spill_writer_a8d069f0f14bfaf07cb78bf49188abb2a}{write\_timer\_}};}
\DoxyCodeLine{00077\ \};}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \textcolor{keyword}{using\ }\mbox{\hyperlink{namespacedoris_1_1vectorized_ab8dec2cecf4bd14d141cfe1277abb912}{BlockSpillWriterUPtr}}\ =\ std::unique\_ptr<BlockSpillWriter>;}
\DoxyCodeLine{00080\ \}\ \textcolor{comment}{//\ namespace\ vectorized}}
\DoxyCodeLine{00081\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
