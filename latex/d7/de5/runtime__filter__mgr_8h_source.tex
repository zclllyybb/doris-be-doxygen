\hypertarget{runtime__filter__mgr_8h_source}{}\doxysection{runtime\+\_\+filter\+\_\+mgr.\+h}
\label{runtime__filter__mgr_8h_source}\index{/Users/dabowang/be\_all/runtime/runtime\_filter\_mgr.h@{/Users/dabowang/be\_all/runtime/runtime\_filter\_mgr.h}}
\mbox{\hyperlink{runtime__filter__mgr_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Licensed\ to\ the\ Apache\ Software\ Foundation\ (ASF)\ under\ one}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ or\ more\ contributor\ license\ agreements.\ \ See\ the\ NOTICE\ file}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ distributed\ with\ this\ work\ for\ additional\ information}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ regarding\ copyright\ ownership.\ \ The\ ASF\ licenses\ this\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ to\ you\ under\ the\ Apache\ License,\ Version\ 2.0\ (the}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ "{}License"{});\ you\ may\ not\ use\ this\ file\ except\ in\ compliance}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ with\ the\ License.\ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00008\ \textcolor{comment}{//}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00010\ \textcolor{comment}{//}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ software\ distributed\ under\ the\ License\ is\ distributed\ on\ an}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ "{}AS\ IS"{}\ BASIS,\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ KIND,\ either\ express\ or\ implied.\ \ See\ the\ License\ for\ the}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ specific\ language\ governing\ permissions\ and\ limitations}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ under\ the\ License.}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ <condition\_variable>}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <map>}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <unordered\_map>}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{object__pool_8h}{common/object\_pool.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{status_8h}{common/status.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{runtime__filter_8h}{exprs/runtime\_filter.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}gen\_cpp/PaloInternalService\_types.h"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}gen\_cpp/PlanNodes\_types.h"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{runtime__state_8h}{runtime/runtime\_state.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{uid__util_8h}{util/uid\_util.h}}"{}}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacebutil}{butil}}\ \{}
\DoxyCodeLine{00036\ \textcolor{keyword}{class\ }IOBufAsZeroCopyInputStream;}
\DoxyCodeLine{00037\ \}}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacedoris}{doris}}\ \{}
\DoxyCodeLine{00040\ \textcolor{keyword}{class\ }TUniqueId;}
\DoxyCodeLine{00041\ \textcolor{keyword}{class\ }RuntimeFilter;}
\DoxyCodeLine{00042\ \textcolor{keyword}{class\ }FragmentExecState;}
\DoxyCodeLine{00043\ \textcolor{keyword}{class\ }PlanFragmentExecutor;}
\DoxyCodeLine{00044\ \textcolor{keyword}{class\ }PPublishFilterRequest;}
\DoxyCodeLine{00045\ \textcolor{keyword}{class\ }PMergeFilterRequest;}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{comment}{//\ owned\ by\ RuntimeState}}
\DoxyCodeLine{00058\ \textcolor{comment}{//\ RuntimeFilterMgr\ will\ be\ destroyed\ when\ RuntimeState\ is\ destroyed}}
\DoxyCodeLine{00059\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr}{RuntimeFilterMgr}}\ \{}
\DoxyCodeLine{00060\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00061\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr}{RuntimeFilterMgr}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\&\ query\_id,\ \mbox{\hyperlink{classdoris_1_1_runtime_state}{RuntimeState}}*\ state);}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_aff9bcbafd8524eb06edb0ae39b46ab5e}{\string~RuntimeFilterMgr}}();}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a223508714f7b7c2a338265d09a23a25f}{init}}();}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{comment}{//\ get\ a\ consumer\ filter\ by\ filter-\/id}}
\DoxyCodeLine{00068\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a0225669dbb712ecc919b503b73e86978}{get\_consume\_filter}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ filter\_id,\ \mbox{\hyperlink{classdoris_1_1_i_runtime_filter}{IRuntimeFilter}}**\ consumer\_filter);}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_af57a8bb102ea84ccf7b142ca73263241}{get\_producer\_filter}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ filter\_id,\ \mbox{\hyperlink{classdoris_1_1_i_runtime_filter}{IRuntimeFilter}}**\ producer\_filter);}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ regist\ filter}}
\DoxyCodeLine{00072\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a70f23095365c30c52bd524ada239f2b4}{register\_filter}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{namespacedoris_aedd540b2388b6902d932a0cc21b7c9eb}{RuntimeFilterRole}}\ role,\ \textcolor{keyword}{const}\ TRuntimeFilterDesc\&\ desc,}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ TQueryOptions\&\ options,\ \textcolor{keywordtype}{int}\ node\_id\ =\ -\/1);}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{comment}{//\ update\ filter\ by\ remote}}
\DoxyCodeLine{00076\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_af0250e83433e0df4cd40da94170c02ac}{update\_filter}}(\textcolor{keyword}{const}\ PPublishFilterRequest*\ request,}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ butil::IOBufAsZeroCopyInputStream*\ \mbox{\hyperlink{uint24_8h_aa99be7b8b4274b2256b394ea7bf80762}{data}});}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a5209e663f1f199188f86844343d538d7}{set\_runtime\_filter\_params}}(\textcolor{keyword}{const}\ TRuntimeFilterParams\&\ runtime\_filter\_params);}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a3f4fe0557536fda0ec15498f97faac71}{get\_merge\_addr}}(TNetworkAddress*\ addr);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00084\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a84b75fe48e51b39b14c58915d88a7a9d}{get\_filter\_by\_role}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ filter\_id,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespacedoris_aedd540b2388b6902d932a0cc21b7c9eb}{RuntimeFilterRole}}\ role,}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_i_runtime_filter}{IRuntimeFilter}}**\ target);}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1_runtime_filter_mgr_1_1_runtime_filter_mgr_val}{RuntimeFilterMgrVal}}\ \{}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacedoris_aedd540b2388b6902d932a0cc21b7c9eb}{RuntimeFilterRole}}\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_mgr_1_1_runtime_filter_mgr_val_a0c475bd12416a395b69068d3bcb58575}{role}};\ \textcolor{comment}{//\ consumer\ or\ producer}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_i_runtime_filter}{IRuntimeFilter}}*\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_mgr_1_1_runtime_filter_mgr_val_a7790fe5fd96eaa48889608c137bd750c}{filter}};}
\DoxyCodeLine{00090\ \ \ \ \ \};}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{comment}{//\ RuntimeFilterMgr\ is\ owned\ by\ RuntimeState,\ so\ we\ only}}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{comment}{//\ use\ filter\_id\ as\ key}}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{comment}{//\ key:\ "{}filter-\/id"{}}}
\DoxyCodeLine{00095\ \textcolor{comment}{}\ \ \ \ std::map<int32\_t,\ RuntimeFilterMgrVal>\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a8c34c54a19c7e894ee9c3c09c991e1e7}{\_consumer\_map}};}
\DoxyCodeLine{00096\ \ \ \ \ std::map<int32\_t,\ RuntimeFilterMgrVal>\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a08b3201fbb7764e6b3a0c3dc8280b198}{\_producer\_map}};}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_state}{RuntimeState}}*\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a91f2150e84757ffe2be5129f52c9e85a}{\_state}};}
\DoxyCodeLine{00099\ \ \ \ \ std::unique\_ptr<MemTracker>\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a036faa8c080bce0c455935d9a85f3f29}{\_tracker}};}
\DoxyCodeLine{00100\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_object_pool}{ObjectPool}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a1a74e93bf13c9f4c5ee8df84755d7f63}{\_pool}};}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ TNetworkAddress\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_a5f7dffc963ecc4327a510adda9226d1d}{\_merge\_addr}};}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_mgr_ab42b61fff67e9baee2dbc53f08bb0306}{\_has\_merge\_addr}};}
\DoxyCodeLine{00105\ \};}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \textcolor{comment}{//\ controller\ -\/>\ <query-\/id,\ entity>}}
\DoxyCodeLine{00108\ \textcolor{comment}{//\ RuntimeFilterMergeControllerEntity\ is\ the\ context\ used\ by\ runtimefilter\ for\ merging}}
\DoxyCodeLine{00109\ \textcolor{comment}{//\ During\ a\ query,\ only\ the\ last\ sink\ node\ owns\ this\ class,\ with\ the\ end\ of\ the\ query,}}
\DoxyCodeLine{00110\ \textcolor{comment}{//\ the\ class\ is\ destroyed\ with\ the\ last\ fragment\_exec.}}
\DoxyCodeLine{00111\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity}{RuntimeFilterMergeControllerEntity}}\ \{}
\DoxyCodeLine{00112\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00113\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a744284d12087ae8075170b1c4b342208}{RuntimeFilterMergeControllerEntity}}(\mbox{\hyperlink{classdoris_1_1_runtime_state}{RuntimeState}}*\ state)}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_ab63a8a27889066367153b850d09eeec1}{\_query\_id}}(0,\ 0),\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a3f46ebacc1c3c74ebca9a64c5db1efa6}{\_fragment\_instance\_id}}(0,\ 0),\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a91f2150e84757ffe2be5129f52c9e85a}{\_state}}(state)\ \{\}}
\DoxyCodeLine{00115\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_afb0a3dec89c5bd7861c8ed4d0b278635}{\string~RuntimeFilterMergeControllerEntity}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a3be48a98e99587b4091242f691c2ad0c}{init}}(\mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a274bb5d603c80806032ce57ea4fd2b69}{query\_id}},\ \mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ fragment\_instance\_id,}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ TRuntimeFilterParams\&\ runtime\_filter\_params,}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ TQueryOptions\&\ query\_options);}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{comment}{//\ handle\ merge\ rpc}}
\DoxyCodeLine{00122\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_ae535322eb056464f8cd0bd8631de2272}{merge}}(\textcolor{keyword}{const}\ PMergeFilterRequest*\ request,}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ butil::IOBufAsZeroCopyInputStream*\ attach\_data);}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a274bb5d603c80806032ce57ea4fd2b69}{query\_id}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_ab63a8a27889066367153b850d09eeec1}{\_query\_id}};\ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_afcdf4b641782498ec0ec92119d8dff12}{instance\_id}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a3f46ebacc1c3c74ebca9a64c5db1efa6}{\_fragment\_instance\_id}};\ \}}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val}{RuntimeFilterCntlVal}}\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ int64\_t\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_ab445728eda7094e7e9110a4cd22d0cfb}{create\_time}};}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_a0cfff000e6208e24782ecd0b9a4f4902}{producer\_size}};}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ TRuntimeFilterDesc\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_a59775546ed92503f2a02107439820ca4}{runtime\_filter\_desc}};}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ std::vector<doris::TRuntimeFilterTargetParams>\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_a6d78984042fa1e23bd2a2873783a2543}{target\_info}};}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_i_runtime_filter}{IRuntimeFilter}}*\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_a7790fe5fd96eaa48889608c137bd750c}{filter}};}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ std::unordered\_set<std::string>\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_a5545856afc3181aa96165160201df719}{arrive\_id}};\ \textcolor{comment}{//\ fragment\_instance\_id\ ?}}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ std::shared\_ptr<ObjectPool>\ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val_ad21b7e1259c312faad94d5f2c9c9fae7}{pool}};}
\DoxyCodeLine{00137\ \ \ \ \ \};}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00140\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_runtime_filter_merge_controller_entity_1_1_runtime_filter_cntl_val}{RuntimeFilterCntlVal}}*\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a31a9e7bc53cff0f98cbb065b28763536}{get\_filter}}(\textcolor{keywordtype}{int}\ \textcolor{keywordtype}{id})\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a388af3875067a1955d341f904f62bd5c}{\_filter\_map}}[std::to\_string(\textcolor{keywordtype}{id})].get();\ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00143\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a31d520bcaf804cfb516d17c61ced1588}{\_init\_with\_desc}}(\textcolor{keyword}{const}\ TRuntimeFilterDesc*\ runtime\_filter\_desc,}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ TQueryOptions*\ query\_options,}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::vector<doris::TRuntimeFilterTargetParams>*\ target\_info,}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ producer\_size);}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_ab63a8a27889066367153b850d09eeec1}{\_query\_id}};}
\DoxyCodeLine{00149\ \ \ \ \ \mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a3f46ebacc1c3c74ebca9a64c5db1efa6}{\_fragment\_instance\_id}};}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{comment}{//\ protect\ \_filter\_map}}
\DoxyCodeLine{00151\ \ \ \ \ std::mutex\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_ae0967ca48d345446a405e1c894522bcf}{\_filter\_map\_mutex}};}
\DoxyCodeLine{00152\ \ \ \ \ std::shared\_ptr<MemTracker>\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_aa8fe1dfdcaa71c1dd164d67c6f3cc910}{\_mem\_tracker}};}
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{comment}{//\ TODO:\ convert\ filter\ id\ to\ i32}}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{comment}{//\ filter-\/id\ -\/>\ val}}
\DoxyCodeLine{00155\ \ \ \ \ std::map<std::string,\ std::shared\_ptr<RuntimeFilterCntlVal>>\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a388af3875067a1955d341f904f62bd5c}{\_filter\_map}};}
\DoxyCodeLine{00156\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_state}{RuntimeState}}*\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity_a91f2150e84757ffe2be5129f52c9e85a}{\_state}};}
\DoxyCodeLine{00157\ \};}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \textcolor{comment}{//\ RuntimeFilterMergeController\ has\ a\ map\ query-\/id\ -\/>\ entity}}
\DoxyCodeLine{00160\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller}{RuntimeFilterMergeController}}\ \{}
\DoxyCodeLine{00161\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00162\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_aa8ac315476f1f8e0be0bffa2a79f4870}{RuntimeFilterMergeController}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00163\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a068e3823fcca0b7c76c17178f1cc08e5}{\string~RuntimeFilterMergeController}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ thread\ safe}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ add\ a\ query-\/id\ -\/>\ entity}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ If\ a\ query-\/id\ -\/>\ entity\ already\ exists}}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{comment}{//\ add\_entity\ will\ return\ a\ exists\ entity}}
\DoxyCodeLine{00169\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_ae0c33139e6bad0b932f747a3f396b803}{add\_entity}}(\textcolor{keyword}{const}\ TExecPlanFragmentParams\&\ params,}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::shared\_ptr<RuntimeFilterMergeControllerEntity>*\ handle,}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_state}{RuntimeState}}*\ state);}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{comment}{//\ thread\ safe}}
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{comment}{//\ increase\ a\ reference\ count}}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{comment}{//\ if\ a\ query-\/id\ is\ not\ exist}}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{comment}{//\ Status.not\_ok\ will\ be\ returned\ and\ a\ empty\ ptr\ will\ returned\ by\ *handle}}
\DoxyCodeLine{00176\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_ad0ca2570bcf68832491066c83e231e3b}{acquire}}(\mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ query\_id,\ std::shared\_ptr<RuntimeFilterMergeControllerEntity>*\ handle);}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{comment}{//\ thread\ safe}}
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{comment}{//\ remove\ a\ entity\ by\ query-\/id}}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{comment}{//\ remove\_entity\ will\ be\ called\ automatically\ by\ entity\ when\ entity\ is\ destroyed}}
\DoxyCodeLine{00181\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_status}{Status}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a1290c5bf8bdca0e71f37a916fe98d051}{remove\_entity}}(\mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\ query\_id);}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a69d22ae2cf055e596af3fdd59b7d8709}{kShardNum}}\ =\ 128;}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00186\ \ \ \ \ uint32\_t\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a783c1bc080eab4a2de255a63db27e336}{\_get\_controller\_shard\_idx}}(\mbox{\hyperlink{structdoris_1_1_unique_id}{UniqueId}}\&\ query\_id)\ \{}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (uint32\_t)query\_id.\mbox{\hyperlink{structdoris_1_1_unique_id_a94ebb4c22130c6225e4853bda2afdede}{hi}}\ \%\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a69d22ae2cf055e596af3fdd59b7d8709}{kShardNum}};}
\DoxyCodeLine{00188\ \ \ \ \ \}}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \ \ std::mutex\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a6df73920a2eb6a71067db46484c19e06}{\_controller\_mutex}}[\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a69d22ae2cf055e596af3fdd59b7d8709}{kShardNum}}];}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{comment}{//\ We\ store\ the\ weak\ pointer\ here.}}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{comment}{//\ When\ the\ external\ object\ is\ destroyed,\ we\ need\ to\ clear\ this\ record}}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a5108440d8049995c45565ffe99eb6996}{FilterControllerMap}}\ =}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ std::unordered\_map<std::string,\ std::weak\_ptr<RuntimeFilterMergeControllerEntity>>;}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{comment}{//\ str(query-\/id)\ -\/>\ entity}}
\DoxyCodeLine{00196\ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a5108440d8049995c45565ffe99eb6996}{FilterControllerMap}}\ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_af6a45a8dbdde0102337451dc5f1dc9d6}{\_filter\_controller\_map}}[\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_a69d22ae2cf055e596af3fdd59b7d8709}{kShardNum}}];}
\DoxyCodeLine{00197\ \};}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \textcolor{keyword}{using\ }\mbox{\hyperlink{namespacedoris_a922964945629481ddb561d0f3e0230e7}{runtime\_filter\_merge\_entity\_closer}}\ =\ std::function<void(\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity}{RuntimeFilterMergeControllerEntity}}*)>;}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespacedoris_a963896937851b4e15997e7c4df318f84}{runtime\_filter\_merge\_entity\_close}}(\mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller}{RuntimeFilterMergeController}}*\ controller,}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classdoris_1_1_runtime_filter_merge_controller_entity}{RuntimeFilterMergeControllerEntity}}*\ entity);}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ \}\ \textcolor{comment}{//\ namespace\ doris}}

\end{DoxyCode}
